---
title: "BDD foot"
author: "David Flouriot"
date: "05/04/2019"
output: html_document
---
```{r}
# A modeliser :

# Nb buts dans le matchs
# But ou pas des deux equipes
# Victoire nul ou défaite
# Prédire + ou - 2,5 buts

```




#Lancement Packrat
```{r}
 
library(packrat)
library(knitr) 
knitr::opts_knit$set(root.dir = '/Users/dflouriot/R/Paris_Sportifs/')
 

packrat::set_opts(symlink.system.packages = TRUE)
#packrat::init('/Users/dflouriot/R/Paris_Sportifs/')
packrat::on(project =  '/Users/dflouriot/R/Paris_Sportifs/',auto.snapshot = T )
 
#install.packages("Rcrawler", dependencies = TRUE)
#remove.packages("xtable")

#Mettre à jour les packages ajoutés ou supprimés
packrat::snapshot()
#Vérifier si tous les packages ont été chargés
packrat::status()
#Nettoyer les packages inutiles
packrat::clean()
#Pour transporter un projet
packrat::bundle()

#Automatique packrat à jour
packrat::set_opts(auto.snapshot = TRUE)

```



#Définition des librairies
```{r}
library(Rcrawler)
library(xml2)
library(httr)
library(XML)
library(data.table)
library(iterators)
library(foreach)
library(doParallel)
library(curl)
library(rvest)
library(stringr)
library(RCurl)
library(dplyr)
library(esquisse)
library(cronR)
library(caret)
library(MASS)
library(pls)
library(jsonlite)  

 
  

```

#test pour crawler les côtes en ligne
```{r}

cote=read_html(paste0('http://www.cotes.fr/football/France-Ligue-1-ed3'))
coteligue = cote %>%
  html_table(fill = TRUE)%>%
  .[2] %>%
  as.data.frame()

parieur= cote %>%
  html_table(fill = TRUE)%>%
  .[1] %>%
  as.data.frame()



#Loading both the required libraries
library(rvest)
library(V8)
#URL with js-rendered content to be scraped
link <- read_html('https://food.list.co.uk/place/22191-brewhemia-edinburgh/')
#Read the html page content and extract all javascript codes that are inside a list
link %>% 
 html_nodes('li') %>% 
 html_nodes('script') %>% 
 html_text()
 
```
#Test pour crawler le site soccerstats

```{r}
 



today <- as.Date(format(Sys.Date(), format="%Y/%m/%d"))
final_match_a_venir=NULL
final_match_passe=NULL
dday=5
for (dday in 0:5) {
 
  ejour=-dday+1
jour= today - as.difftime(ejour, unit="days") 
 

match_soccerstat=   GET(paste0("https://www.soccerstats.com/matches.asp?matchday=",dday), 
set_cookies('sc_is_visitor_unique' = ' rx2749989.1554131493.F29D33C110DA4F4329286B70842951B8.6.5.4.4.4.4.4.4.4',
              'cookiesok'='yes',
              'cdisp'='yes',
              'tz'='60',
              '_sm_au_c'='iVV7hJh4jH0r44s210')) %>%
read_html
                      
 
match_soccerstat=match_soccerstat %>%
html_nodes('.trow8')  %>%
html_text()
         
e=matrix(nrow = length(match_soccerstat),ncol=41)
for (i in 1:41) {
e[,i]= sapply(strsplit(match_soccerstat, "\n"), function(x) x[i])
         }

match_s=as.data.frame(e)
match_s=match_s[,-c(6,8,9,11,12,16,18,19,20,23,24,26,29,30,32,33,35)]
 
match_s=as.data.frame(apply(match_s, 2, function(y) gsub("\r", "", y)))
match_s$date_scrap=today
match_s$jour=dday

match_a_venir=match_s %>%
  filter(V22=='')

match_passe=match_s %>%
  filter(V22!='')
 
final_match_a_venir=rbind(match_a_venir,final_match_a_venir)
final_match_passe=rbind(match_passe,final_match_passe)
} 

#Extraction de toutes les URL des rencontres 
stat_match=match_soccerstat %>%
html_nodes('.trow8')  %>%
html_nodes('a') %>%
html_attr('href')

stat_match <- as.data.frame(stat_match[which(regexpr('pmatch.asp', stat_match) >= 1)])

idx2 <- sapply(paste0(gsub(" ","-",tolower(match_s$V17)),'-vs-',gsub(" ","-",tolower(match_s$V25))), grep,stat_match[,1])
#stat_match <- stat_match[which(regexpr('pmatch.asp?league=', stat_match) >= 1)]
idx1 <- sapply(seq_along(idx2), function(i) rep(i, length(idx2[[i]])))

stat_match_final=cbind(match_s[unlist(idx1),,drop=F], stat_match[unlist(idx2),,drop=F])
 
test=stat_match_final[1,27]
face_a_soccerstat=   GET(paste0("https://www.soccerstats.com/",test), 
set_cookies('sc_is_visitor_unique' = ' rx2749989.1554131493.F29D33C110DA4F4329286B70842951B8.6.5.4.4.4.4.4.4.4',
              'cookiesok'='yes',
              'cdisp'='yes',
              'tz'='60',
              '_sm_au_c'='iVV7hJh4jH0r44s210')) %>%
read_html
face_a_soccerstat1= face_a_soccerstat %>%
  html_table(fill = TRUE)


```

#Scrapping calendrier ligue1 sur le site de la LFP
```{r}
 

# initialisaiton du data.frame de sortie
fetch_l1_calendar=NULL

for (saison in c(100:102)) {
  #saison=20
  calendar=NULL
  
 
  # boucle sur les journee
  for (j in 1:38){
    #j=2
    #saison=100
    # creation de l'url de requete
   
    url <- paste0("http://www.lfp.fr/ligue1/competitionPluginCalendrierResultat/changeCalendrierJournee?sai=",saison,"&jour=",j)
        url <- paste0("https://www.lfp.fr/ligue1/calendrier_resultat?sai=102&jour=33") 
    # extraction du code html
    site <- read_html(url)
    #save(site,file="site") 
    # nombre de jour dans la journee
    site %>% 
      html_node("body") %>%
      as.character() %>%
      str_count("<h4>") -> n_day
    
    if (n_day!=0){
      for (i in 1:n_day){
        i=1
        # xpath match
        xpath<-paste0('//*[@id="tableaux_rencontres"]/div/table[',i,']')
        
        # xpath date
        xpath2<-paste0('//*[@id="tableaux_rencontres"]/div/h4[',i,']')
        
        # recuperation des matchs
        site %>% 
          html_node("body") %>%
          html_node(xpath=xpath) %>%
          html_table -> temp
        
        # recuperation de la date
        site %>% 
          html_node("body") %>%
          html_node(xpath=xpath2) %>%
          html_text -> temp2
        
        calendar <- rbind(calendar,cbind(j,temp2,temp))
        
      }
    }  
    } 
    
    # pour chaque jour recuperation de la date et des match
    
  
  # supression des variables inutiles
  calendar <- calendar[,c(1,2,3,4,6,8)]
  
  # renomage des colones
  colnames(calendar) <- c("journee","date","time","home","score","away")
  
  # separation du score en deux variables
  calendar <- cbind(calendar,str_split_fixed(calendar$score," - ",n = 2))
  
  # supression de l'ancienne colone de score
  #calendar <- calendar[,-5]
  
  # renomage des colones de scores
  colnames(calendar)[c(7,8)] <- c("home_score","away_score")
  calendar[,7]<-as.numeric(as.character(calendar[,7]))
  calendar[,8]<-as.numeric(as.character(calendar[,8]))
  calendar$saison<-saison
 
  
  fetch_l1_calendar=rbind(fetch_l1_calendar,calendar)
  print(saison)
}

#Rajout de la saison par année
ref_saison = fetch_l1_calendar %>%
  filter(journee==1) %>%
  group_by(saison) %>%
  filter(row_number()==1) %>%
  ungroup() %>%
  mutate(saison_annee=paste0(row_number()+1949,"/",row_number()+1950)) %>%
  dplyr::select(saison,saison_annee)

#On joint et on remet les colonnes dans le bon ordre
fetch_l1_calendar_final= fetch_l1_calendar %>%
  left_join(ref_saison,by="saison") %>%
  dplyr::select(saison,saison_annee,journee,date,time,home,score,away,home_score,away_score)

# #On sauvegarde les fichiers
# save(fetch_l1_calendar_final,file="/home/ldapusers/dflouriot/Analyse/Crawl_foot/Extraction_calendrier_L1.RData")
# write.csv(fetch_l1_calendar_final,file="/home/ldapusers/dflouriot/Analyse/Crawl_foot/Extraction_calendrier_L1.csv")

#
fetch_l1_calendar_final$DD=sapply(strsplit(as.character(fetch_l1_calendar_final$date), " "), function(x) x[2])
fetch_l1_calendar_final$MM=sapply(strsplit(as.character(fetch_l1_calendar_final$date), " "), function(x) x[3])
fetch_l1_calendar_final$YY=sapply(strsplit(as.character(fetch_l1_calendar_final$date), " "), function(x) x[4])


fetch_l1_calendar_final_=fetch_l1_calendar_final %>%
  mutate(MM=
           ifelse(MM=='janvier',01,
           ifelse(MM=='février',02,
           ifelse(MM=='mars',03,
           ifelse(MM=='avril',04,
           ifelse(MM=='mai',05,
           ifelse(MM=='juin',06,
           ifelse(MM=='juillet',07,
           ifelse(MM=='août',08,
           ifelse(MM=='septembre',09,
           ifelse(MM=='octobre',10,
           ifelse(MM=='novembre',11,
           ifelse(MM=='décembre',12,00)))))))))))),
         Date=as.Date(paste0(as.character(DD),"-",as.character(MM),"-",as.character(YY)),format='%d-%m-%Y')
         ) %>%
  rename(Team_home=home,
         Team_away=away,
         Final_H=home_score,
         Final_A=away_score) %>%
  mutate(Final_R=ifelse(Final_H>Final_A,'H',ifelse(Final_H<Final_A,'A','D'))) %>%
  dplyr::select(saison,saison_annee,Date,Team_home,Team_away,Final_R,Final_H,Final_A)
 
```



#Récupération d'une base de données sur plusieurs championnats de foot avec un longue histo
```{r}
score=read.csv2(file="/Users/dflouriot/R/Paris_Sportifs/BDD_histo_bet_scores.csv")
score=score[,c(1:35)]
#save(score,file="/Users/dflouriot/R/Paris_Sportifs/BDD_histo_bet_scores.RData")

score=score %>%
  mutate(MM=
           ifelse(MM=='Jan',01,
           ifelse(MM=='Feb',02,
           ifelse(MM=='Mar',03,
           ifelse(MM=='Apr',04,
           ifelse(MM=='May',05,
           ifelse(MM=='Jun',06,
           ifelse(MM=='Jul',07,
           ifelse(MM=='Aug',08,
           ifelse(MM=='Sep',09,
           ifelse(MM=='Oct',10,
           ifelse(MM=='Nov',11,
           ifelse(MM=='Dec',12,00)))))))))))),
         Date=as.Date(paste0(DD,"-",MM,"-",YY),format='%d-%m-%Y')
         
         
         ) 
                                                     
indx=c('First_H','First_A','Second_H','Second_A','Final_H','Final_A')
 
score[indx] <- lapply(score[indx], function(x) as.numeric(as.character(x)))                 
 
score_france= score %>%
  filter(Country=='France' & Season=='2018/2019' & League=='Ligue 1')
```

#Trouver le classement à date de chaque équipe 

```{r}
#fetch_l1_calendar_final_ ou  score_france
baso=fetch_l1_calendar_final_

classement_home = baso %>%
  dplyr::select(saison,Date,Team_home,Final_R ) %>%
  mutate(points=ifelse(Final_R=='H',3,ifelse(Final_R=='A',0,ifelse(Final_R=='D',1,0))),
         nb_matchs=ifelse(is.na(Final_R)==F,1,0)) %>%
  rename(Team=Team_home) %>%
  dplyr::select(saison,Date,Team,points,nb_matchs)

classement_away = baso %>%
  dplyr::select(saison,Date,Team_away,Final_R ) %>%
  mutate(points=ifelse(Final_R=='A',3,ifelse(Final_R=='H',0,ifelse(Final_R=='D',1,0))),
         nb_matchs=ifelse(is.na(Final_R)==F,1,0)) %>%
  rename(Team=Team_away) %>%
  dplyr::select(saison,Date,Team,points,nb_matchs)

classement_ens = rbind(classement_away,classement_home) %>%
  arrange(Date)

classement_team=NULL
for (s in unique(classement_ens$saison)) {
  
 

date_vector=classement_ens%>% filter(saison==s) %>% distinct(Date)
date_vector=unique(date_vector$Date)


 
for (i in date_vector) {
  
s=100
  #i='2016-12-17'
  class_tempo=classement_ens %>%
    filter(Date<i & saison==s) %>%
    #select(Team,points) %>%
    group_by(Team) %>%
    summarise(
      
      points=sum(as.numeric(as.character(points)),na.rm = T),nb_matchs=sum(nb_matchs,na.rm = T)) %>%
       
    arrange(desc(points)) %>%
    ungroup() %>%
    mutate(Date=as.Date(i,origin="1970-01-01"),classement=row_number(),saison=s) %>%
    dplyr::select(saison,Team,classement,Date,nb_matchs)
  

  classement_team=rbind(classement_team,class_tempo)
  
}

}
score_france_= baso %>%
  left_join(classement_team,by=c("Team_home"="Team","Date"="Date","saison"="saison")) %>%
  rename(classement_H=classement) %>%
  left_join(classement_team[,1:4],by=c("Team_away"="Team","Date"="Date","saison"="saison")) %>%
  rename(classement_A=classement) 
 
```

#Création des indicateurs en fonction d'une journée (Version LFP)

```{r}


#Classement chaque jour en live
class_home = score_france_ %>%
  dplyr::select(saison,Date,Team_home,Final_R,Final_H,Final_A) %>%
  mutate(
    points=ifelse(Final_R=='H',3,ifelse(Final_R=='A',0,ifelse(Final_R=='D',1,0))),
         points_H=ifelse(Final_R=='H',3,ifelse(Final_R=='A',0,ifelse(Final_R=='D',1,0))),
         points_A=0,
         nb_matchs_H=ifelse(is.na(Final_R)==F,1,0),
         nb_matchs_A=0,
         nb_vict=ifelse(Final_R=='H',1,0),
         nb_def=ifelse(Final_R=='A',1,0),
         nb_nul=ifelse(Final_R=='D',1,0),
         nb_vict_H=ifelse(Final_R=='H',1,0),
         nb_def_H=ifelse(Final_R=='A',1,0),
         nb_nul_H=ifelse(Final_R=='D',1,0),
         buts_marq_A=0,buts_enc_A=0,buts_marq_H=Final_H,buts_enc_H=Final_A,
         nb_vict_A=0,
         nb_def_A=0,
         nb_nul_A=0,
         nb_nonunique=ifelse(Final_H>0 & Final_A>0,1,0),
         nb_unique=ifelse(Final_H==0 | Final_A==0,1,0),
         nb_nonunique_A=0,
         nb_unique_A=0,
         nb_nonunique_H=ifelse(Final_H>0 & Final_A>0,1,0),
         nb_unique_H=ifelse(Final_H==0 | Final_A==0,1,0),
         nb_0p5_buts= ifelse(as.numeric(as.character(Final_H))+as.numeric(as.character(Final_A))>=1,1,0),
         nb_1p5_buts=ifelse(as.numeric(as.character(Final_H))+as.numeric(as.character(Final_A))>=2,1,0),
         nb_2p5_buts=ifelse(as.numeric(as.character(Final_H))+as.numeric(as.character(Final_A))>=3,1,0),
         nb_3p5_buts=ifelse(as.numeric(as.character(Final_H))+as.numeric(as.character(Final_A))>=4,1,0),
         nb_4p5_buts=ifelse(as.numeric(as.character(Final_H))+as.numeric(as.character(Final_A))>=5,1,0),
         nb_0p5_buts_marq= ifelse(as.numeric(as.character(Final_H))>=1,1,0),
         nb_1p5_buts_marq=ifelse(as.numeric(as.character(Final_H))>=2,1,0),
         nb_2p5_buts_marq=ifelse(as.numeric(as.character(Final_H))>=3,1,0),
         nb_3p5_buts_marq=ifelse(as.numeric(as.character(Final_H))>=4,1,0),
         nb_4p5_buts_marq=ifelse(as.numeric(as.character(Final_H))>=5,1,0),
         nb_0p5_buts_enc=ifelse(as.numeric(as.character(Final_A))>=1,1,0),
         nb_1p5_buts_enc=ifelse(as.numeric(as.character(Final_A))>=2,1,0),
         nb_2p5_buts_enc=ifelse(as.numeric(as.character(Final_A))>=3,1,0),
         nb_3p5_buts_enc=ifelse(as.numeric(as.character(Final_A))>=4,1,0),
         nb_4p5_buts_enc=ifelse(as.numeric(as.character(Final_A))>=5,1,0),
    
      nb_0p5_buts_H= ifelse(as.numeric(as.character(Final_H))+as.numeric(as.character(Final_A))>=1,1,0),
         nb_1p5_buts_H=ifelse(as.numeric(as.character(Final_H))+as.numeric(as.character(Final_A))>=2,1,0),
         nb_2p5_buts_H=ifelse(as.numeric(as.character(Final_H))+as.numeric(as.character(Final_A))>=3,1,0),
         nb_3p5_buts_H=ifelse(as.numeric(as.character(Final_H))+as.numeric(as.character(Final_A))>=4,1,0),
         nb_4p5_buts_H=ifelse(as.numeric(as.character(Final_H))+as.numeric(as.character(Final_A))>=5,1,0),
        nb_0p5_buts_marq_H= ifelse(as.numeric(as.character(Final_H))>=1,1,0),
         nb_1p5_buts_marq_H=ifelse(as.numeric(as.character(Final_H))>=2,1,0),
         nb_2p5_buts_marq_H=ifelse(as.numeric(as.character(Final_H))>=3,1,0),
         nb_3p5_buts_marq_H=ifelse(as.numeric(as.character(Final_H))>=4,1,0),
         nb_4p5_buts_marq_H=ifelse(as.numeric(as.character(Final_H))>=5,1,0),
         nb_0p5_buts_enc_H=ifelse(as.numeric(as.character(Final_A))>=1,1,0),
         nb_1p5_buts_enc_H=ifelse(as.numeric(as.character(Final_A))>=2,1,0),
         nb_2p5_buts_enc_H=ifelse(as.numeric(as.character(Final_A))>=3,1,0),
         nb_3p5_buts_enc_H=ifelse(as.numeric(as.character(Final_A))>=4,1,0),
         nb_4p5_buts_enc_H=ifelse(as.numeric(as.character(Final_A))>=5,1,0),
        nb_0p5_buts_A=0,
        nb_1p5_buts_A=0,
        nb_2p5_buts_A=0,
        nb_3p5_buts_A=0,
        nb_4p5_buts_A=0,
        nb_0p5_buts_marq_A=0,
        nb_1p5_buts_marq_A=0,
        nb_2p5_buts_marq_A=0,
        nb_3p5_buts_marq_A=0,
        nb_4p5_buts_marq_A=0,
        nb_0p5_buts_enc_A=0,
        nb_1p5_buts_enc_A=0,
        nb_2p5_buts_enc_A=0,
        nb_3p5_buts_enc_A=0,
        nb_4p5_buts_enc_A=0,
    
            marge_buts_0=ifelse(as.numeric(as.character(Final_A))-as.numeric(as.character(Final_H))==0,1,0),
         marge_buts_plus_1=ifelse(as.numeric(as.character(Final_A))-as.numeric(as.character(Final_H))==1,1,0),
         marge_buts_plus_2=ifelse(as.numeric(as.character(Final_A))-as.numeric(as.character(Final_H))==2,1,0),
         marge_buts_plus_3=ifelse(as.numeric(as.character(Final_A))-as.numeric(as.character(Final_H))==3,1,0),
         marge_buts_plus_4=ifelse(as.numeric(as.character(Final_A))-as.numeric(as.character(Final_H))>=4,1,0),
         marge_buts_moins_1=ifelse(as.numeric(as.character(Final_A))-as.numeric(as.character(Final_H))==-1,1,0),
        marge_buts_moins_2=ifelse(as.numeric(as.character(Final_A))-as.numeric(as.character(Final_H))==-2,1,0),
        marge_buts_moins_3=ifelse(as.numeric(as.character(Final_A))-as.numeric(as.character(Final_H))==-3,1,0),
        marge_buts_moins_4=ifelse(as.numeric(as.character(Final_A))-as.numeric(as.character(Final_H))<=-4,1,0),
                 marge_buts_ecart_1=ifelse(abs(as.numeric(as.character(Final_A))-as.numeric(as.character(Final_H)))==1,1,0),
        marge_buts_ecart_2=ifelse(abs(as.numeric(as.character(Final_A))-as.numeric(as.character(Final_H)))==2,1,0),
        marge_buts_ecart_3=ifelse(abs(as.numeric(as.character(Final_A))-as.numeric(as.character(Final_H)))==3,1,0),
        marge_buts_ecart_4=ifelse(abs(as.numeric(as.character(Final_A))-as.numeric(as.character(Final_H)))>=4,1,0),
            marge_buts_0_H=ifelse(as.numeric(as.character(Final_A))-as.numeric(as.character(Final_H))==0,1,0),
         marge_buts_plus_1_H=ifelse(as.numeric(as.character(Final_A))-as.numeric(as.character(Final_H))==1,1,0),
         marge_buts_plus_2_H=ifelse(as.numeric(as.character(Final_A))-as.numeric(as.character(Final_H))==2,1,0),
         marge_buts_plus_3_H=ifelse(as.numeric(as.character(Final_A))-as.numeric(as.character(Final_H))==3,1,0),
         marge_buts_plus_4_H=ifelse(as.numeric(as.character(Final_A))-as.numeric(as.character(Final_H))>=4,1,0),
         marge_buts_moins_1_H=ifelse(as.numeric(as.character(Final_A))-as.numeric(as.character(Final_H))==-1,1,0),
        marge_buts_moins_2_H=ifelse(as.numeric(as.character(Final_A))-as.numeric(as.character(Final_H))==-2,1,0),
        marge_buts_moins_3_H=ifelse(as.numeric(as.character(Final_A))-as.numeric(as.character(Final_H))==-3,1,0),
        marge_buts_moins_4_H=ifelse(as.numeric(as.character(Final_A))-as.numeric(as.character(Final_H))<=-4,1,0),
        marge_buts_ecart_1_H=ifelse(abs(as.numeric(as.character(Final_A))-as.numeric(as.character(Final_H)))==1,1,0),
        marge_buts_ecart_2_H=ifelse(abs(as.numeric(as.character(Final_A))-as.numeric(as.character(Final_H)))==2,1,0),
        marge_buts_ecart_3_H=ifelse(abs(as.numeric(as.character(Final_A))-as.numeric(as.character(Final_H)))==3,1,0),
        marge_buts_ecart_4_H=ifelse(abs(as.numeric(as.character(Final_A))-as.numeric(as.character(Final_H)))>=4,1,0),
                    marge_buts_0_A=0,
         marge_buts_plus_1_A=0,
         marge_buts_plus_2_A=0,
         marge_buts_plus_3_A=0,
         marge_buts_plus_4_A=0,
         marge_buts_moins_1_A=0,
        marge_buts_moins_2_A=0,
        marge_buts_moins_3_A=0,
        marge_buts_moins_4_A=0,
        marge_buts_ecart_1_A=0,
        marge_buts_ecart_2_A=0,
        marge_buts_ecart_3_A=0,
        marge_buts_ecart_4_A=0,
           une_seule_equipe_marq=ifelse(as.numeric(as.character(Final_A))==0 | as.numeric(as.character(Final_H))==0,1,0),
        deux_equipes_marq=ifelse(as.numeric(as.character(Final_A))>=1 & as.numeric(as.character(Final_H))>=1,1,0),
        clean_sheet=ifelse(as.numeric(as.character(Final_A))==0,1,0),
        clean_sheet_H=ifelse(as.numeric(as.character(Final_A))==0,1,0),
        clean_sheet_A=as.numeric(0)
         ) %>%
  rename(Team=Team_home,buts_marq=Final_H,buts_enc=Final_A
        ) %>%
dplyr::select(saison,Date,Team,nb_matchs_A,nb_matchs_H,points,points_A,points_H,nb_vict,nb_def,nb_nul,nb_vict_A,nb_def_A,nb_nul_A,nb_vict_H,nb_def_H,nb_nul_H,nb_nonunique,nb_nonunique_A,nb_nonunique_H,nb_unique,nb_unique_H,nb_unique_A,buts_marq,buts_marq_H,buts_marq_A,buts_enc,buts_enc_H,buts_enc_A,nb_0p5_buts,nb_1p5_buts,nb_2p5_buts,nb_3p5_buts,nb_4p5_buts,nb_0p5_buts_marq,nb_1p5_buts_marq,nb_2p5_buts_marq,nb_3p5_buts_marq,nb_4p5_buts_marq,nb_0p5_buts_enc,nb_1p5_buts_enc,nb_2p5_buts_enc,nb_3p5_buts_enc,nb_4p5_buts_enc,nb_0p5_buts_H,nb_1p5_buts_H,nb_2p5_buts_H,nb_3p5_buts_H,nb_4p5_buts_H,nb_0p5_buts_marq_H,nb_1p5_buts_marq_H,nb_2p5_buts_marq_H,nb_3p5_buts_marq_H,nb_4p5_buts_marq_H,nb_0p5_buts_enc_H,nb_1p5_buts_enc_H,nb_2p5_buts_enc_H,nb_3p5_buts_enc_H,nb_4p5_buts_enc_H,nb_0p5_buts_A,nb_1p5_buts_A,nb_2p5_buts_A,nb_3p5_buts_A,nb_4p5_buts_A,nb_0p5_buts_marq_A,nb_1p5_buts_marq_A,nb_2p5_buts_marq_A,nb_3p5_buts_marq_A,nb_4p5_buts_marq_A,nb_0p5_buts_enc_A,nb_1p5_buts_enc_A,nb_2p5_buts_enc_A,nb_3p5_buts_enc_A,nb_4p5_buts_enc_A,marge_buts_0,marge_buts_plus_1,marge_buts_plus_2,marge_buts_plus_3,marge_buts_plus_4,marge_buts_moins_1,marge_buts_moins_2,marge_buts_moins_3,marge_buts_moins_4,marge_buts_ecart_1,marge_buts_ecart_2,marge_buts_ecart_3,marge_buts_ecart_4,marge_buts_0_H,marge_buts_plus_1_H,marge_buts_plus_2_H,marge_buts_plus_3_H,marge_buts_plus_4_H,marge_buts_moins_1_H,marge_buts_moins_2_H,marge_buts_moins_3_H,marge_buts_moins_4_H,marge_buts_ecart_1_H,marge_buts_ecart_2_H,marge_buts_ecart_3_H,marge_buts_ecart_4_H,marge_buts_0_A,marge_buts_plus_1_A,marge_buts_plus_2_A,marge_buts_plus_3_A,marge_buts_plus_4_A,marge_buts_moins_1_A,marge_buts_moins_2_A,marge_buts_moins_3_A,marge_buts_moins_4_A,marge_buts_ecart_1_A,marge_buts_ecart_2_A,marge_buts_ecart_3_A,marge_buts_ecart_4_A,une_seule_equipe_marq,deux_equipes_marq,clean_sheet,clean_sheet_H,clean_sheet_A)

class_away = score_france_ %>%
  dplyr::select(saison,Date,Team_away,Final_R,Final_H,Final_A) %>%
  mutate(points=ifelse(Final_R=='A',3,ifelse(Final_R=='H',0,ifelse(Final_R=='D',1,0))),
         points_A=ifelse(Final_R=='A',3,ifelse(Final_R=='H',0,ifelse(Final_R=='D',1,0))),
         points_H=0,
         nb_matchs_H=0,
         nb_matchs_A=ifelse(is.na(Final_R)==F,1,0),
         nb_vict=ifelse(Final_R=='A',1,0),
         nb_def=ifelse(Final_R=='H',1,0),
         nb_nul=ifelse(Final_R=='D',1,0),
         nb_vict_A=ifelse(Final_R=='A',1,0),
         nb_def_A=ifelse(Final_R=='H',1,0),
         nb_nul_A=ifelse(Final_R=='D',1,0),
         nb_vict_H=0,
         nb_def_H=0,
         nb_nul_H=0,
         nb_nonunique=ifelse(Final_H>0 & Final_A>0,1,0),
         nb_unique=ifelse(Final_H==0 | Final_A==0,1,0),
         nb_nonunique_H=0,
         nb_unique_H=0,
         nb_nonunique_A=ifelse(Final_H>0 & Final_A>0,1,0),
         nb_unique_A=ifelse(Final_H==0 | Final_A==0,1,0),
         buts_marq_H=0,buts_enc_H=0,buts_marq_A=Final_A,buts_enc_A=Final_H,
         nb_0p5_buts= ifelse(as.numeric(as.character(Final_H))+as.numeric(as.character(Final_A))>=1,1,0),
         nb_1p5_buts=ifelse(as.numeric(as.character(Final_H))+as.numeric(as.character(Final_A))>=2,1,0),
         nb_2p5_buts=ifelse(as.numeric(as.character(Final_H))+as.numeric(as.character(Final_A))>=3,1,0),
         nb_3p5_buts=ifelse(as.numeric(as.character(Final_H))+as.numeric(as.character(Final_A))>=4,1,0),
         nb_4p5_buts=ifelse(as.numeric(as.character(Final_H))+as.numeric(as.character(Final_A))>=5,1,0),
        nb_0p5_buts_marq= ifelse(as.numeric(as.character(Final_A))>=1,1,0),
         nb_1p5_buts_marq=ifelse(as.numeric(as.character(Final_A))>=2,1,0),
         nb_2p5_buts_marq=ifelse(as.numeric(as.character(Final_A))>=3,1,0),
         nb_3p5_buts_marq=ifelse(as.numeric(as.character(Final_A))>=4,1,0),
         nb_4p5_buts_marq=ifelse(as.numeric(as.character(Final_A))>=5,1,0),
         nb_0p5_buts_enc=ifelse(as.numeric(as.character(Final_H))>=1,1,0),
         nb_1p5_buts_enc=ifelse(as.numeric(as.character(Final_H))>=2,1,0),
         nb_2p5_buts_enc=ifelse(as.numeric(as.character(Final_H))>=3,1,0),
         nb_3p5_buts_enc=ifelse(as.numeric(as.character(Final_H))>=4,1,0),
         nb_4p5_buts_enc=ifelse(as.numeric(as.character(Final_H))>=5,1,0),
         nb_0p5_buts_A= ifelse(as.numeric(as.character(Final_H))+as.numeric(as.character(Final_A))>=1,1,0),
         nb_1p5_buts_A=ifelse(as.numeric(as.character(Final_H))+as.numeric(as.character(Final_A))>=2,1,0),
         nb_2p5_buts_A=ifelse(as.numeric(as.character(Final_H))+as.numeric(as.character(Final_A))>=3,1,0),
         nb_3p5_buts_A=ifelse(as.numeric(as.character(Final_H))+as.numeric(as.character(Final_A))>=4,1,0),
         nb_4p5_buts_A=ifelse(as.numeric(as.character(Final_H))+as.numeric(as.character(Final_A))>=5,1,0),
        nb_0p5_buts_marq_A= ifelse(as.numeric(as.character(Final_A))>=1,1,0),
         nb_1p5_buts_marq_A=ifelse(as.numeric(as.character(Final_A))>=2,1,0),
         nb_2p5_buts_marq_A=ifelse(as.numeric(as.character(Final_A))>=3,1,0),
         nb_3p5_buts_marq_A=ifelse(as.numeric(as.character(Final_A))>=4,1,0),
         nb_4p5_buts_marq_A=ifelse(as.numeric(as.character(Final_A))>=5,1,0),
         nb_0p5_buts_enc_A=ifelse(as.numeric(as.character(Final_H))>=1,1,0),
         nb_1p5_buts_enc_A=ifelse(as.numeric(as.character(Final_H))>=2,1,0),
         nb_2p5_buts_enc_A=ifelse(as.numeric(as.character(Final_H))>=3,1,0),
         nb_3p5_buts_enc_A=ifelse(as.numeric(as.character(Final_H))>=4,1,0),
         nb_4p5_buts_enc_A=ifelse(as.numeric(as.character(Final_H))>=5,1,0),
        nb_0p5_buts_H=0,
        nb_1p5_buts_H=0,
        nb_2p5_buts_H=0,
        nb_3p5_buts_H=0,
        nb_4p5_buts_H=0,
        nb_0p5_buts_marq_H=0,
        nb_1p5_buts_marq_H=0,
        nb_2p5_buts_marq_H=0,
        nb_3p5_buts_marq_H=0,
        nb_4p5_buts_marq_H=0,
        nb_0p5_buts_enc_H=0,
        nb_1p5_buts_enc_H=0,
        nb_2p5_buts_enc_H=0,
        nb_3p5_buts_enc_H=0,
        nb_4p5_buts_enc_H=0,
        marge_buts_0=ifelse(as.numeric(as.character(Final_A))-as.numeric(as.character(Final_H))==0,1,0),
         marge_buts_plus_1=ifelse(as.numeric(as.character(Final_A))-as.numeric(as.character(Final_H))==1,1,0),
         marge_buts_plus_2=ifelse(as.numeric(as.character(Final_A))-as.numeric(as.character(Final_H))==2,1,0),
         marge_buts_plus_3=ifelse(as.numeric(as.character(Final_A))-as.numeric(as.character(Final_H))==3,1,0),
         marge_buts_plus_4=ifelse(as.numeric(as.character(Final_A))-as.numeric(as.character(Final_H))>=4,1,0),
         marge_buts_moins_1=ifelse(as.numeric(as.character(Final_A))-as.numeric(as.character(Final_H))==-1,1,0),
        marge_buts_moins_2=ifelse(as.numeric(as.character(Final_A))-as.numeric(as.character(Final_H))==-2,1,0),
        marge_buts_moins_3=ifelse(as.numeric(as.character(Final_A))-as.numeric(as.character(Final_H))==-3,1,0),
        marge_buts_moins_4=ifelse(as.numeric(as.character(Final_A))-as.numeric(as.character(Final_H))<=-4,1,0),
        marge_buts_ecart_1=ifelse(abs(as.numeric(as.character(Final_A))-as.numeric(as.character(Final_H)))==1,1,0),
        marge_buts_ecart_2=ifelse(abs(as.numeric(as.character(Final_A))-as.numeric(as.character(Final_H)))==2,1,0),
        marge_buts_ecart_3=ifelse(abs(as.numeric(as.character(Final_A))-as.numeric(as.character(Final_H)))==3,1,0),
        marge_buts_ecart_4=ifelse(abs(as.numeric(as.character(Final_A))-as.numeric(as.character(Final_H)))>=4,1,0),
            marge_buts_0_A=ifelse(as.numeric(as.character(Final_A))-as.numeric(as.character(Final_H))==0,1,0),
         marge_buts_plus_1_A=ifelse(as.numeric(as.character(Final_A))-as.numeric(as.character(Final_H))==1,1,0),
         marge_buts_plus_2_A=ifelse(as.numeric(as.character(Final_A))-as.numeric(as.character(Final_H))==2,1,0),
         marge_buts_plus_3_A=ifelse(as.numeric(as.character(Final_A))-as.numeric(as.character(Final_H))==3,1,0),
         marge_buts_plus_4_A=ifelse(as.numeric(as.character(Final_A))-as.numeric(as.character(Final_H))>=4,1,0),
         marge_buts_moins_1_A=ifelse(as.numeric(as.character(Final_A))-as.numeric(as.character(Final_H))==-1,1,0),
        marge_buts_moins_2_A=ifelse(as.numeric(as.character(Final_A))-as.numeric(as.character(Final_H))==-2,1,0),
        marge_buts_moins_3_A=ifelse(as.numeric(as.character(Final_A))-as.numeric(as.character(Final_H))==-3,1,0),
        marge_buts_moins_4_A=ifelse(as.numeric(as.character(Final_A))-as.numeric(as.character(Final_H))<=-4,1,0),
        marge_buts_ecart_1_A=ifelse(abs(as.numeric(as.character(Final_A))-as.numeric(as.character(Final_H)))==1,1,0),
        marge_buts_ecart_2_A=ifelse(abs(as.numeric(as.character(Final_A))-as.numeric(as.character(Final_H)))==2,1,0),
        marge_buts_ecart_3_A=ifelse(abs(as.numeric(as.character(Final_A))-as.numeric(as.character(Final_H)))==3,1,0),
        marge_buts_ecart_4_A=ifelse(abs(as.numeric(as.character(Final_A))-as.numeric(as.character(Final_H)))>=4,1,0),
                    marge_buts_0_H=0,
         marge_buts_plus_1_H=0,
         marge_buts_plus_2_H=0,
         marge_buts_plus_3_H=0,
         marge_buts_plus_4_H=0,
         marge_buts_moins_1_H=0,
        marge_buts_moins_2_H=0,
        marge_buts_moins_3_H=0,
        marge_buts_moins_4_H=0,
        marge_buts_ecart_1_H=0,
        marge_buts_ecart_2_H=0,
        marge_buts_ecart_3_H=0,
        marge_buts_ecart_4_H=0,
        une_seule_equipe_marq=ifelse(as.numeric(as.character(Final_A))==0 | as.numeric(as.character(Final_H))==0,1,0),
        deux_equipes_marq=ifelse(as.numeric(as.character(Final_A))>=1 & as.numeric(as.character(Final_H))>=1,1,0),
        clean_sheet=ifelse(as.numeric(as.character(Final_H))==0,1,0),
        clean_sheet_A=ifelse(as.numeric(as.character(Final_H))==0,1,0),
        clean_sheet_H=as.numeric(0)
         ) %>%
  rename(Team=Team_away,buts_marq=Final_A,buts_enc=Final_H)  %>%
dplyr::select(saison,Date,Team,nb_matchs_A,nb_matchs_H,points,points_A,points_H,nb_vict,nb_def,nb_nul,nb_vict_A,nb_def_A,nb_nul_A,nb_vict_H,nb_def_H,nb_nul_H,nb_nonunique,nb_nonunique_A,nb_nonunique_H,nb_unique,nb_unique_H,nb_unique_A,buts_marq,buts_marq_H,buts_marq_A,buts_enc,buts_enc_H,buts_enc_A,nb_0p5_buts,nb_1p5_buts,nb_2p5_buts,nb_3p5_buts,nb_4p5_buts,nb_0p5_buts_marq,nb_1p5_buts_marq,nb_2p5_buts_marq,nb_3p5_buts_marq,nb_4p5_buts_marq,nb_0p5_buts_enc,nb_1p5_buts_enc,nb_2p5_buts_enc,nb_3p5_buts_enc,nb_4p5_buts_enc,nb_0p5_buts_H,nb_1p5_buts_H,nb_2p5_buts_H,nb_3p5_buts_H,nb_4p5_buts_H,nb_0p5_buts_marq_H,nb_1p5_buts_marq_H,nb_2p5_buts_marq_H,nb_3p5_buts_marq_H,nb_4p5_buts_marq_H,nb_0p5_buts_enc_H,nb_1p5_buts_enc_H,nb_2p5_buts_enc_H,nb_3p5_buts_enc_H,nb_4p5_buts_enc_H,nb_0p5_buts_A,nb_1p5_buts_A,nb_2p5_buts_A,nb_3p5_buts_A,nb_4p5_buts_A,nb_0p5_buts_marq_A,nb_1p5_buts_marq_A,nb_2p5_buts_marq_A,nb_3p5_buts_marq_A,nb_4p5_buts_marq_A,nb_0p5_buts_enc_A,nb_1p5_buts_enc_A,nb_2p5_buts_enc_A,nb_3p5_buts_enc_A,nb_4p5_buts_enc_A,marge_buts_0,marge_buts_plus_1,marge_buts_plus_2,marge_buts_plus_3,marge_buts_plus_4,marge_buts_moins_1,marge_buts_moins_2,marge_buts_moins_3,marge_buts_moins_4,marge_buts_ecart_1,marge_buts_ecart_2,marge_buts_ecart_3,marge_buts_ecart_4,marge_buts_0_H,marge_buts_plus_1_H,marge_buts_plus_2_H,marge_buts_plus_3_H,marge_buts_plus_4_H,marge_buts_moins_1_H,marge_buts_moins_2_H,marge_buts_moins_3_H,marge_buts_moins_4_H,marge_buts_ecart_1_H,marge_buts_ecart_2_H,marge_buts_ecart_3_H,marge_buts_ecart_4_H,marge_buts_0_A,marge_buts_plus_1_A,marge_buts_plus_2_A,marge_buts_plus_3_A,marge_buts_plus_4_A,marge_buts_moins_1_A,marge_buts_moins_2_A,marge_buts_moins_3_A,marge_buts_moins_4_A,marge_buts_ecart_1_A,marge_buts_ecart_2_A,marge_buts_ecart_3_A,marge_buts_ecart_4_A,une_seule_equipe_marq,deux_equipes_marq,clean_sheet,clean_sheet_H,clean_sheet_A)

class_ens = rbind(class_away,class_home) %>%
  arrange(Date)

date_vect=unique(class_ens$Date)  
  

classement=NULL

for (s in unique(classement_ens$saison)) {
  
 

date_vect=classement_ens%>% filter(saison==s) %>% distinct(Date)
date_vect=unique(date_vect$Date)

for (i in date_vect[-c(1:6)]) {
  #i='2019-04-19'
  class_temp=class_ens %>%
    filter(Date<i & saison==s) %>%
    #select(Team,points) %>%
    group_by(Team) %>%
    summarise(
      nb_matchs=sum(as.numeric(as.character(nb_matchs_A)),as.numeric(as.character(nb_matchs_H)),na.rm = T),
      nb_matchs_H=sum(as.numeric(as.character(nb_matchs_H)),na.rm = T),
      nb_matchs_A=sum(as.numeric(as.character(nb_matchs_A)),na.rm = T),
      points=sum(as.numeric(as.character(points)),na.rm = T),
        points_H=sum(as.numeric(as.character(points_H)),na.rm = T),
        points_A=sum(as.numeric(as.character(points_A)),na.rm = T),
         nb_vict=sum(as.numeric(as.character(nb_vict)),na.rm = T),
         nb_def=sum(as.numeric(as.character(nb_def)),na.rm = T),
         nb_nul=sum(as.numeric(as.character(nb_nul)),na.rm = T),
         nb_vict_A=sum(as.numeric(as.character(nb_vict_A)),na.rm = T),
         nb_def_A=sum(as.numeric(as.character(nb_def_A)),na.rm = T),
         nb_nul_A=sum(as.numeric(as.character(nb_nul_A)),na.rm = T),
         nb_vict_H=sum(as.numeric(as.character(nb_vict_H)),na.rm = T),
         nb_def_H=sum(as.numeric(as.character(nb_def_H)),na.rm = T),
         nb_nul_H=sum(as.numeric(as.character(nb_nul_H)),na.rm = T),
      nb_nonunique=sum(as.numeric(as.character(nb_nonunique)),na.rm = T),
      nb_nonunique_A=sum(as.numeric(as.character(nb_nonunique_A)),na.rm = T),
      nb_nonunique_H=sum(as.numeric(as.character(nb_nonunique_H)),na.rm = T),
      nb_unique=sum(as.numeric(as.character(nb_unique)),na.rm = T),
      nb_unique_H=sum(as.numeric(as.character(nb_unique_H)),na.rm = T),
      nb_unique_A=sum(as.numeric(as.character(nb_unique_A)),na.rm = T),
      buts_marq=sum(as.numeric(as.character(buts_marq)),na.rm = T),
      buts_enc=sum(as.numeric(as.character(buts_enc)),na.rm = T),
      buts_marq_H=sum(as.numeric(as.character(buts_marq_H)),na.rm = T),
      buts_marq_A=sum(as.numeric(as.character(buts_marq_A)),na.rm = T),
      buts_enc_H=sum(as.numeric(as.character(buts_enc_H)),na.rm = T),
      buts_enc_A=sum(as.numeric(as.character(buts_enc_A)),na.rm = T),
      nb_0p5_buts=sum(nb_0p5_buts,na.rm = T),
      nb_1p5_buts=sum(nb_1p5_buts,na.rm = T),
      nb_2p5_buts=sum(nb_2p5_buts,na.rm = T),
      nb_3p5_buts=sum(nb_3p5_buts,na.rm = T),
      nb_4p5_buts=sum(nb_4p5_buts,na.rm = T),
      nb_0p5_buts_marq=sum(nb_0p5_buts_marq,na.rm = T),
      nb_1p5_buts_marq=sum(nb_1p5_buts_marq,na.rm = T),
      nb_2p5_buts_marq=sum(nb_2p5_buts_marq,na.rm = T),
      nb_3p5_buts_marq=sum(nb_3p5_buts_marq,na.rm = T),
      nb_4p5_buts_marq=sum(nb_4p5_buts_marq,na.rm = T),
      nb_0p5_buts_enc=sum(nb_0p5_buts_enc,na.rm = T),
      nb_1p5_buts_enc=sum(nb_1p5_buts_enc,na.rm = T),
      nb_2p5_buts_enc=sum(nb_2p5_buts_enc,na.rm = T),
      nb_3p5_buts_enc=sum(nb_3p5_buts_enc,na.rm = T),
      nb_4p5_buts_enc=sum(nb_4p5_buts_enc,na.rm = T),
      nb_0p5_buts_H=sum(nb_0p5_buts_H,na.rm = T),
      nb_1p5_buts_H=sum(nb_1p5_buts_H,na.rm = T),
      nb_2p5_buts_H=sum(nb_2p5_buts_H,na.rm = T),
      nb_3p5_buts_H=sum(nb_3p5_buts_H,na.rm = T),
      nb_4p5_buts_H=sum(nb_4p5_buts_H,na.rm = T),
      nb_0p5_buts_marq_H=sum(nb_0p5_buts_marq_H,na.rm = T),
      nb_1p5_buts_marq_H=sum(nb_1p5_buts_marq_H,na.rm = T),
      nb_2p5_buts_marq_H=sum(nb_2p5_buts_marq_H,na.rm = T),
      nb_3p5_buts_marq_H=sum(nb_3p5_buts_marq_H,na.rm = T),
      nb_4p5_buts_marq_H=sum(nb_4p5_buts_marq_H,na.rm = T),
      nb_0p5_buts_enc_H=sum(nb_0p5_buts_enc_H,na.rm = T),
      nb_1p5_buts_enc_H=sum(nb_1p5_buts_enc_H,na.rm = T),
      nb_2p5_buts_enc_H=sum(nb_2p5_buts_enc_H,na.rm = T),
      nb_3p5_buts_enc_H=sum(nb_3p5_buts_enc_H,na.rm = T),
      nb_4p5_buts_enc_H=sum(nb_4p5_buts_enc_H,na.rm = T),
      nb_0p5_buts_A=sum(nb_0p5_buts_A,na.rm = T),
      nb_1p5_buts_A=sum(nb_1p5_buts_A,na.rm = T),
      nb_2p5_buts_A=sum(nb_2p5_buts_A,na.rm = T),
      nb_3p5_buts_A=sum(nb_3p5_buts_A,na.rm = T),
      nb_4p5_buts_A=sum(nb_4p5_buts_A,na.rm = T),
      nb_0p5_buts_marq_A=sum(nb_0p5_buts_marq_A,na.rm = T),
      nb_1p5_buts_marq_A=sum(nb_1p5_buts_marq_A,na.rm = T),
      nb_2p5_buts_marq_A=sum(nb_2p5_buts_marq_A,na.rm = T),
      nb_3p5_buts_marq_A=sum(nb_3p5_buts_marq_A,na.rm = T),
      nb_4p5_buts_marq_A=sum(nb_4p5_buts_marq_A,na.rm = T),
      nb_0p5_buts_enc_A=sum(nb_0p5_buts_enc_A,na.rm = T),
      nb_1p5_buts_enc_A=sum(nb_1p5_buts_enc_A,na.rm = T),
      nb_2p5_buts_enc_A=sum(nb_2p5_buts_enc_A,na.rm = T),
      nb_3p5_buts_enc_A=sum(nb_3p5_buts_enc_A,na.rm = T),
      nb_4p5_buts_enc_A=sum(nb_4p5_buts_enc_A,na.rm = T),
      marge_buts_0=sum(marge_buts_0,na.rm = T),
      marge_buts_plus_1=sum(marge_buts_plus_1,na.rm = T),
      marge_buts_plus_2=sum(marge_buts_plus_2,na.rm = T),
      marge_buts_plus_3=sum(marge_buts_plus_3,na.rm = T),
      marge_buts_plus_4=sum(marge_buts_plus_4,na.rm = T),
      marge_buts_moins_1=sum(marge_buts_moins_1,na.rm = T),
      marge_buts_moins_2=sum(marge_buts_moins_2,na.rm = T),
      marge_buts_moins_3=sum(marge_buts_moins_3,na.rm = T),
      marge_buts_moins_4=sum(marge_buts_moins_4,na.rm = T),
      marge_buts_ecart_1=sum(marge_buts_ecart_1,na.rm = T),
      marge_buts_ecart_2=sum(marge_buts_ecart_2,na.rm = T),
      marge_buts_ecart_3=sum(marge_buts_ecart_3,na.rm = T),
      marge_buts_ecart_4=sum(marge_buts_ecart_4,na.rm = T),
      marge_buts_0_H=sum(marge_buts_0_H,na.rm = T),
      marge_buts_plus_1_H=sum(marge_buts_plus_1_H,na.rm = T),
      marge_buts_plus_2_H=sum(marge_buts_plus_2_H,na.rm = T),
      marge_buts_plus_3_H=sum(marge_buts_plus_3_H,na.rm = T),
      marge_buts_plus_4_H=sum(marge_buts_plus_4_H,na.rm = T),
      marge_buts_moins_1_H=sum(marge_buts_moins_1_H,na.rm = T),
      marge_buts_moins_2_H=sum(marge_buts_moins_2_H,na.rm = T),
      marge_buts_moins_3_H=sum(marge_buts_moins_3_H,na.rm = T),
      marge_buts_moins_4_H=sum(marge_buts_moins_4_H,na.rm = T),
      marge_buts_ecart_1_H=sum(marge_buts_ecart_1_H,na.rm = T),
      marge_buts_ecart_2_H=sum(marge_buts_ecart_2_H,na.rm = T),
      marge_buts_ecart_3_H=sum(marge_buts_ecart_3_H,na.rm = T),
      marge_buts_ecart_4_H=sum(marge_buts_ecart_4_H,na.rm = T),
      marge_buts_0_A=sum(marge_buts_0_A,na.rm = T),
      marge_buts_plus_1_A=sum(marge_buts_plus_1_A,na.rm = T),
      marge_buts_plus_2_A=sum(marge_buts_plus_2_A,na.rm = T),
      marge_buts_plus_3_A=sum(marge_buts_plus_3_A,na.rm = T),
      marge_buts_plus_4_A=sum(marge_buts_plus_4_A,na.rm = T),
      marge_buts_moins_1_A=sum(marge_buts_moins_1_A,na.rm = T),
      marge_buts_moins_2_A=sum(marge_buts_moins_2_A,na.rm = T),
      marge_buts_moins_3_A=sum(marge_buts_moins_3_A,na.rm = T),
      marge_buts_moins_4_A=sum(marge_buts_moins_4_A,na.rm = T),
      marge_buts_ecart_1_A=sum(marge_buts_ecart_1_A,na.rm = T),
      marge_buts_ecart_2_A=sum(marge_buts_ecart_2_A,na.rm = T),
      marge_buts_ecart_3_A=sum(marge_buts_ecart_3_A,na.rm = T),
      marge_buts_ecart_4_A=sum(marge_buts_ecart_4_A,na.rm = T),
      une_seule_equipe_marq=sum(une_seule_equipe_marq,na.rm = T),
        deux_equipes_marq=sum(deux_equipes_marq,na.rm = T),
        clean_sheet=sum(clean_sheet,na.rm = T),
      clean_sheet_H=sum(clean_sheet_H,na.rm = T),
      clean_sheet_A=sum(clean_sheet_A,na.rm = T)
      
      ) %>%
    arrange(desc(points)) %>%
    mutate(saison=s,Date=as.Date(i,origin="1970-01-01"),
           diff_buts=buts_marq-buts_enc,
           buts_marq_match=buts_marq/nb_matchs,
           buts_marq_match_H=buts_marq_H/nb_matchs_H,
           buts_marq_match_A=buts_marq_A/nb_matchs_A,
           buts_enc_match=buts_enc/nb_matchs,
           buts_enc_match_H=buts_enc_H/nb_matchs_H,
           buts_enc_match_A=buts_enc_A/nb_matchs_A,
           points_marq_match=points/nb_matchs,
           points_marq_match_H=points_H/nb_matchs_H,
           points_marq_match_A=points_A/nb_matchs_A,
           buts_match=buts_marq_match+buts_enc_match_H,
           buts_match_H=buts_marq_match_H+buts_enc_match_H,
           buts_match_A=buts_marq_match_A+buts_enc_match_A,
           part_nb_0p5_buts=nb_0p5_buts/nb_matchs,
           part_nb_1p5_buts=nb_1p5_buts/nb_matchs,
           part_nb_2p5_buts=nb_2p5_buts/nb_matchs,
           part_nb_3p5_buts=nb_3p5_buts/nb_matchs,
           part_nb_4p5_buts=nb_4p5_buts/nb_matchs,
           part_nb_0p5_buts_marq=nb_0p5_buts_marq/nb_matchs,
           part_nb_1p5_buts_marq=nb_1p5_buts_marq/nb_matchs,
           part_nb_2p5_buts_marq=nb_2p5_buts_marq/nb_matchs,
           part_nb_3p5_buts_marq=nb_3p5_buts_marq/nb_matchs,
           part_nb_4p5_buts_marq=nb_4p5_buts_marq/nb_matchs,
           part_nb_0p5_buts_enc=nb_0p5_buts_enc/nb_matchs,
           part_nb_1p5_buts_enc=nb_1p5_buts_enc/nb_matchs,
           part_nb_2p5_buts_enc=nb_2p5_buts_enc/nb_matchs,
           part_nb_3p5_buts_enc=nb_3p5_buts_enc/nb_matchs,
           part_nb_4p5_buts_enc=nb_4p5_buts_enc/nb_matchs,
               part_nb_0p5_buts_H=nb_0p5_buts/nb_matchs_H,
           part_nb_1p5_buts_H=nb_1p5_buts_H/nb_matchs_H,
           part_nb_2p5_buts_H=nb_2p5_buts_H/nb_matchs_H,
           part_nb_3p5_buts_H=nb_3p5_buts_H/nb_matchs_H,
           part_nb_4p5_buts_H=nb_4p5_buts_H/nb_matchs_H,
           part_nb_0p5_buts_marq_H=nb_0p5_buts_marq_H/nb_matchs_H,
           part_nb_1p5_buts_marq_H=nb_1p5_buts_marq_H/nb_matchs_H,
           part_nb_2p5_buts_marq_H=nb_2p5_buts_marq_H/nb_matchs_H,
           part_nb_3p5_buts_marq_H=nb_3p5_buts_marq_H/nb_matchs_H,
           part_nb_4p5_buts_marq_H=nb_4p5_buts_marq_H/nb_matchs_H,
           part_nb_0p5_buts_enc_H=nb_0p5_buts_enc_H/nb_matchs_H,
           part_nb_1p5_buts_enc_H=nb_1p5_buts_enc_H/nb_matchs_H,
           part_nb_2p5_buts_enc_H=nb_2p5_buts_enc_H/nb_matchs_H,
           part_nb_3p5_buts_enc_H=nb_3p5_buts_enc_H/nb_matchs_H,
           part_nb_4p5_buts_enc_H=nb_4p5_buts_enc_H/nb_matchs_H,
               part_nb_0p5_buts_A=nb_0p5_buts/nb_matchs_A,
           part_nb_1p5_buts_A=nb_1p5_buts_A/nb_matchs_A,
           part_nb_2p5_buts_A=nb_2p5_buts_A/nb_matchs_A,
           part_nb_3p5_buts_A=nb_3p5_buts_A/nb_matchs_A,
           part_nb_4p5_buts_A=nb_4p5_buts_A/nb_matchs_A,
           part_nb_0p5_buts_marq_A=nb_0p5_buts_marq_A/nb_matchs_A,
           part_nb_1p5_buts_marq_A=nb_1p5_buts_marq_A/nb_matchs_A,
           part_nb_2p5_buts_marq_A=nb_2p5_buts_marq_A/nb_matchs_A,
           part_nb_3p5_buts_marq_A=nb_3p5_buts_marq_A/nb_matchs_A,
           part_nb_4p5_buts_marq_A=nb_4p5_buts_marq_A/nb_matchs_A,
           part_nb_0p5_buts_enc_A=nb_0p5_buts_enc_A/nb_matchs_A,
           part_nb_1p5_buts_enc_A=nb_1p5_buts_enc_A/nb_matchs_A,
           part_nb_2p5_buts_enc_A=nb_2p5_buts_enc_A/nb_matchs_A,
           part_nb_3p5_buts_enc_A=nb_3p5_buts_enc_A/nb_matchs_A,
           part_nb_4p5_buts_enc_A=nb_4p5_buts_enc_A/nb_matchs_A,
           part_marge_buts_0=marge_buts_0/nb_matchs,
      part_marge_buts_0=marge_buts_0/nb_matchs,
      part_marge_buts_plus_1=marge_buts_plus_1/nb_matchs,
      part_marge_buts_plus_2=marge_buts_plus_2/nb_matchs,
      part_marge_buts_plus_3=marge_buts_plus_3/nb_matchs,
      part_marge_buts_plus_4=marge_buts_plus_4/nb_matchs,
      part_marge_buts_moins_1=marge_buts_moins_1/nb_matchs,
      part_marge_buts_moins_2=marge_buts_moins_2/nb_matchs,
      part_marge_buts_moins_3=marge_buts_moins_3/nb_matchs,
      part_marge_buts_moins_4=marge_buts_moins_4/nb_matchs,
      part_marge_buts_ecart_1=marge_buts_ecart_1/nb_matchs,
      part_marge_buts_ecart_2=marge_buts_ecart_2/nb_matchs,
      part_marge_buts_ecart_3=marge_buts_ecart_3/nb_matchs,
      part_marge_buts_ecart_4=marge_buts_ecart_4/nb_matchs,
      part_marge_buts_0_H=marge_buts_0_H/nb_matchs_H,
      part_marge_buts_plus_1_H=marge_buts_plus_1_H/nb_matchs_H,
      part_marge_buts_plus_2_H=marge_buts_plus_2_H/nb_matchs_H,
      part_marge_buts_plus_3_H=marge_buts_plus_3_H/nb_matchs_H,
      part_marge_buts_plus_4_H=marge_buts_plus_4_H/nb_matchs_H,
      part_marge_buts_moins_1_H=marge_buts_moins_1_H/nb_matchs_H,
      part_marge_buts_moins_2_H=marge_buts_moins_2_H/nb_matchs_H,
      part_marge_buts_moins_3_H=marge_buts_moins_3_H/nb_matchs_H,
      part_marge_buts_moins_4_H=marge_buts_moins_4_H/nb_matchs_H,
      part_marge_buts_ecart_1_H=marge_buts_ecart_1_H/nb_matchs_H,
      part_marge_buts_ecart_2_H=marge_buts_ecart_2_H/nb_matchs_H,
      part_marge_buts_ecart_3_H=marge_buts_ecart_3_H/nb_matchs_H,
      part_marge_buts_ecart_4_H=marge_buts_ecart_4_H/nb_matchs_H,
      part_marge_buts_0_A=marge_buts_0_A/nb_matchs_A,
      part_marge_buts_plus_1_A=marge_buts_plus_1_A/nb_matchs_A,
      part_marge_buts_plus_2_A=marge_buts_plus_2_A/nb_matchs_A,
      part_marge_buts_plus_3_A=marge_buts_plus_3_A/nb_matchs_A,
      part_marge_buts_plus_4_A=marge_buts_plus_4_A/nb_matchs_A,
      part_marge_buts_moins_1_A=marge_buts_moins_1_A/nb_matchs_A,
      part_marge_buts_moins_2_A=marge_buts_moins_2_A/nb_matchs_A,
      part_marge_buts_moins_3_A=marge_buts_moins_3_A/nb_matchs_A,
      part_marge_buts_moins_4_A=marge_buts_moins_4_A/nb_matchs_A,
      part_marge_buts_ecart_1_A=marge_buts_ecart_1_A/nb_matchs_A,
      part_marge_buts_ecart_2_A=marge_buts_ecart_2_A/nb_matchs_A,
      part_marge_buts_ecart_3_A=marge_buts_ecart_3_A/nb_matchs_A,
      part_marge_buts_ecart_4_A=marge_buts_ecart_4_A/nb_matchs_A,
      part_une_seule_equipe_marq=une_seule_equipe_marq/nb_matchs,
      part_deux_equipes_marq=deux_equipes_marq/nb_matchs,
      part_clean_sheet=clean_sheet/nb_matchs,
      part_clean_sheet_H=clean_sheet_H/nb_matchs_H,
      part_clean_sheet_A=clean_sheet_A/nb_matchs_A     
           ) %>%
    arrange(desc(points),desc(diff_buts)) %>%
    ungroup() %>%
    mutate(classement=row_number())
  
  
  classement=rbind(classement,class_temp) 
}
}

  
#  
# classement_var_H= classement %>%
#   dplyr::select(Team,
#          Date,
#            buts_marq_match,
#            buts_marq_match_H,
#            buts_enc_match,
#            buts_enc_match_H,
#            points_marq_match,
#            points_marq_match_H,
#            buts_match,
#            buts_match_H,
#            part_nb_0p5_buts,
#            part_nb_1p5_buts,
#            part_nb_2p5_buts,
#            part_nb_3p5_buts,
#            part_nb_4p5_buts,
#            part_nb_0p5_buts_marq,
#            part_nb_1p5_buts_marq,
#            part_nb_2p5_buts_marq,
#            part_nb_3p5_buts_marq,
#            part_nb_4p5_buts_marq,
#            part_nb_0p5_buts_enc,
#            part_nb_1p5_buts_enc,
#            part_nb_2p5_buts_enc,
#            part_nb_3p5_buts_enc,
#            part_nb_4p5_buts_enc,
#            part_marge_buts_0,
#       part_marge_buts_0,
#       part_marge_buts_plus_1,
#       part_marge_buts_plus_2,
#       part_marge_buts_plus_3,
#       part_marge_buts_plus_4,
#       part_marge_buts_moins_1,
#       part_marge_buts_moins_2,
#       part_marge_buts_moins_3,
#       part_marge_buts_moins_4,
#       part_marge_buts_ecart_1,
#       part_marge_buts_ecart_2,
#       part_marge_buts_ecart_3,
#       part_marge_buts_ecart_4,
#       part_marge_buts_0_H,
#       part_marge_buts_plus_1_H,
#       part_marge_buts_plus_2_H,
#       part_marge_buts_plus_3_H,
#       part_marge_buts_plus_4_H,
#       part_marge_buts_moins_1_H,
#       part_marge_buts_moins_2_H,
#       part_marge_buts_moins_3_H,
#       part_marge_buts_moins_4_H,
#       part_marge_buts_ecart_1_H,
#       part_marge_buts_ecart_2_H,
#       part_marge_buts_ecart_3_H,
#       part_marge_buts_ecart_4_H,
#       part_une_seule_equipe_marq,
#       part_deux_equipes_marq,
#       part_clean_sheet,
#       part_clean_sheet_H 
#   ) %>%
#   distinct(Team,
#          Date,
#            buts_marq_match,
#            buts_marq_match_H,
#            buts_enc_match,
#            buts_enc_match_H,
#            points_marq_match,
#            points_marq_match_H,
#            buts_match,
#            buts_match_H,
#            part_nb_0p5_buts,
#            part_nb_1p5_buts,
#            part_nb_2p5_buts,
#            part_nb_3p5_buts,
#            part_nb_4p5_buts,
#            part_nb_0p5_buts_marq,
#            part_nb_1p5_buts_marq,
#            part_nb_2p5_buts_marq,
#            part_nb_3p5_buts_marq,
#            part_nb_4p5_buts_marq,
#            part_nb_0p5_buts_enc,
#            part_nb_1p5_buts_enc,
#            part_nb_2p5_buts_enc,
#            part_nb_3p5_buts_enc,
#            part_nb_4p5_buts_enc,
#            part_marge_buts_0,
#       part_marge_buts_0,
#       part_marge_buts_plus_1,
#       part_marge_buts_plus_2,
#       part_marge_buts_plus_3,
#       part_marge_buts_plus_4,
#       part_marge_buts_moins_1,
#       part_marge_buts_moins_2,
#       part_marge_buts_moins_3,
#       part_marge_buts_moins_4,
#       part_marge_buts_ecart_1,
#       part_marge_buts_ecart_2,
#       part_marge_buts_ecart_3,
#       part_marge_buts_ecart_4,
#       part_marge_buts_0_H,
#       part_marge_buts_plus_1_H,
#       part_marge_buts_plus_2_H,
#       part_marge_buts_plus_3_H,
#       part_marge_buts_plus_4_H,
#       part_marge_buts_moins_1_H,
#       part_marge_buts_moins_2_H,
#       part_marge_buts_moins_3_H,
#       part_marge_buts_moins_4_H,
#       part_marge_buts_ecart_1_H,
#       part_marge_buts_ecart_2_H,
#       part_marge_buts_ecart_3_H,
#       part_marge_buts_ecart_4_H,
#       part_une_seule_equipe_marq,
#       part_deux_equipes_marq,
#       part_clean_sheet,
#       part_clean_sheet_H )
#   classement_var_A= classement %>%
#   dplyr::select(Team,
#          Date,
#            buts_marq_match,
#            buts_marq_match_A,
#            buts_enc_match,
#            buts_enc_match_A,
#            points_marq_match,
#            points_marq_match_A,
#            buts_match,
#            buts_match_A,
#            part_nb_0p5_buts,
#            part_nb_1p5_buts,
#            part_nb_2p5_buts,
#            part_nb_3p5_buts,
#            part_nb_4p5_buts,
#            part_nb_0p5_buts_marq,
#            part_nb_1p5_buts_marq,
#            part_nb_2p5_buts_marq,
#            part_nb_3p5_buts_marq,
#            part_nb_4p5_buts_marq,
#            part_nb_0p5_buts_enc,
#            part_nb_1p5_buts_enc,
#            part_nb_2p5_buts_enc,
#            part_nb_3p5_buts_enc,
#            part_nb_4p5_buts_enc,
#            part_marge_buts_0,
#       part_marge_buts_0,
#       part_marge_buts_plus_1,
#       part_marge_buts_plus_2,
#       part_marge_buts_plus_3,
#       part_marge_buts_plus_4,
#       part_marge_buts_moins_1,
#       part_marge_buts_moins_2,
#       part_marge_buts_moins_3,
#       part_marge_buts_moins_4,
#       part_marge_buts_ecart_1,
#       part_marge_buts_ecart_2,
#       part_marge_buts_ecart_3,
#       part_marge_buts_ecart_4,
#       part_marge_buts_0_A,
#       part_marge_buts_plus_1_A,
#       part_marge_buts_plus_2_A,
#       part_marge_buts_plus_3_A,
#       part_marge_buts_plus_4_A,
#       part_marge_buts_moins_1_A,
#       part_marge_buts_moins_2_A,
#       part_marge_buts_moins_3_A,
#       part_marge_buts_moins_4_A,
#       part_marge_buts_ecart_1_A,
#       part_marge_buts_ecart_2_A,
#       part_marge_buts_ecart_3_A,
#       part_marge_buts_ecart_4_A,
#       part_une_seule_equipe_marq,
#       part_deux_equipes_marq,
#       part_clean_sheet,
#       part_clean_sheet_A ) %>%
# 
#   distinct(Team,
#          Date,
#            buts_marq_match,
#            buts_marq_match_A,
#            buts_enc_match,
#            buts_enc_match_A,
#            points_marq_match,
#            points_marq_match_A,
#            buts_match,
#            buts_match_A,
#            part_nb_0p5_buts,
#            part_nb_1p5_buts,
#            part_nb_2p5_buts,
#            part_nb_3p5_buts,
#            part_nb_4p5_buts,
#            part_nb_0p5_buts_marq,
#            part_nb_1p5_buts_marq,
#            part_nb_2p5_buts_marq,
#            part_nb_3p5_buts_marq,
#            part_nb_4p5_buts_marq,
#            part_nb_0p5_buts_enc,
#            part_nb_1p5_buts_enc,
#            part_nb_2p5_buts_enc,
#            part_nb_3p5_buts_enc,
#            part_nb_4p5_buts_enc,
#            part_marge_buts_0,
#       part_marge_buts_0,
#       part_marge_buts_plus_1,
#       part_marge_buts_plus_2,
#       part_marge_buts_plus_3,
#       part_marge_buts_plus_4,
#       part_marge_buts_moins_1,
#       part_marge_buts_moins_2,
#       part_marge_buts_moins_3,
#       part_marge_buts_moins_4,
#       part_marge_buts_ecart_1,
#       part_marge_buts_ecart_2,
#       part_marge_buts_ecart_3,
#       part_marge_buts_ecart_4,
#       part_marge_buts_0_A,
#       part_marge_buts_plus_1_A,
#       part_marge_buts_plus_2_A,
#       part_marge_buts_plus_3_A,
#       part_marge_buts_plus_4_A,
#       part_marge_buts_moins_1_A,
#       part_marge_buts_moins_2_A,
#       part_marge_buts_moins_3_A,
#       part_marge_buts_moins_4_A,
#       part_marge_buts_ecart_1_A,
#       part_marge_buts_ecart_2_A,
#       part_marge_buts_ecart_3_A,
#       part_marge_buts_ecart_4_A,
#       part_une_seule_equipe_marq,
#       part_deux_equipes_marq,
#       part_clean_sheet,
#       part_clean_sheet_A
#   )
#   
#  
#   
  
# classement_var_H= classement %>%
#   dplyr::select(Team,
#          Date,
#           buts_marq_match_H,
#            buts_enc_match_H,
#            points_marq_match_H,
#       part_marge_buts_0_H,
#       part_marge_buts_plus_1_H,
#       part_marge_buts_plus_2_H,
#       part_marge_buts_plus_3_H,
#       part_marge_buts_plus_4_H,
#       part_marge_buts_moins_1_H,
#       part_marge_buts_moins_2_H,
#       part_marge_buts_moins_3_H,
#       part_marge_buts_moins_4_H,
#       part_marge_buts_ecart_1_H,
#       part_marge_buts_ecart_2_H,
#       part_marge_buts_ecart_3_H,
#       part_marge_buts_ecart_4_H,
#       part_clean_sheet_H,
#            part_nb_0p5_buts_H,
#            part_nb_1p5_buts_H,
#            part_nb_2p5_buts_H,
#            part_nb_3p5_buts_H,
#            part_nb_4p5_buts_H,
#            part_nb_0p5_buts_marq_H,
#            part_nb_1p5_buts_marq_H,
#            part_nb_2p5_buts_marq_H,
#            part_nb_3p5_buts_marq_H,
#            part_nb_4p5_buts_marq_H,
#            part_nb_0p5_buts_enc_H,
#            part_nb_1p5_buts_enc_H,
#            part_nb_2p5_buts_enc_H,
#            part_nb_3p5_buts_enc_H,
#            part_nb_4p5_buts_enc_H
#   ) %>%
#   distinct(Team,Date,
#                  buts_marq_match_H,
#            buts_enc_match_H,
#            points_marq_match_H,
#       part_marge_buts_0_H,
#       part_marge_buts_plus_1_H,
#       part_marge_buts_plus_2_H,
#       part_marge_buts_plus_3_H,
#       part_marge_buts_plus_4_H,
#       part_marge_buts_moins_1_H,
#       part_marge_buts_moins_2_H,
#       part_marge_buts_moins_3_H,
#       part_marge_buts_moins_4_H,
#       part_marge_buts_ecart_1_H,
#       part_marge_buts_ecart_2_H,
#       part_marge_buts_ecart_3_H,
#       part_marge_buts_ecart_4_H,
#       part_clean_sheet_H,
#          part_nb_0p5_buts_H,
#            part_nb_1p5_buts_H,
#            part_nb_2p5_buts_H,
#            part_nb_3p5_buts_H,
#            part_nb_4p5_buts_H,
#            part_nb_0p5_buts_marq_H,
#            part_nb_1p5_buts_marq_H,
#            part_nb_2p5_buts_marq_H,
#            part_nb_3p5_buts_marq_H,
#            part_nb_4p5_buts_marq_H,
#            part_nb_0p5_buts_enc_H,
#            part_nb_1p5_buts_enc_H,
#            part_nb_2p5_buts_enc_H,
#            part_nb_3p5_buts_enc_H,
#            part_nb_4p5_buts_enc_H)
#   classement_var_A= classement %>%
#   dplyr::select(Team,
#          Date,
#            buts_marq_match_A,
#            buts_enc_match_A,
#            points_marq_match_A,
#       part_marge_buts_0_A,
#       part_marge_buts_plus_1_A,
#       part_marge_buts_plus_2_A,
#       part_marge_buts_plus_3_A,
#       part_marge_buts_plus_4_A,
#       part_marge_buts_moins_1_A,
#       part_marge_buts_moins_2_A,
#       part_marge_buts_moins_3_A,
#       part_marge_buts_moins_4_A,
#       part_marge_buts_ecart_1_A,
#       part_marge_buts_ecart_2_A,
#       part_marge_buts_ecart_3_A,
#       part_marge_buts_ecart_4_A,
#       part_clean_sheet_A,
#          part_nb_0p5_buts_A,
#            part_nb_1p5_buts_A,
#            part_nb_2p5_buts_A,
#            part_nb_3p5_buts_A,
#            part_nb_4p5_buts_A,
#            part_nb_0p5_buts_marq_A,
#            part_nb_1p5_buts_marq_A,
#            part_nb_2p5_buts_marq_A,
#            part_nb_3p5_buts_marq_A,
#            part_nb_4p5_buts_marq_A,
#            part_nb_0p5_buts_enc_A,
#            part_nb_1p5_buts_enc_A,
#            part_nb_2p5_buts_enc_A,
#            part_nb_3p5_buts_enc_A,
#            part_nb_4p5_buts_enc_A) %>%
# 
#   distinct(Team,
#          Date,
#            buts_marq_match_A,
#            buts_enc_match_A,
#            points_marq_match_A,
#       part_marge_buts_0_A,
#       part_marge_buts_plus_1_A,
#       part_marge_buts_plus_2_A,
#       part_marge_buts_plus_3_A,
#       part_marge_buts_plus_4_A,
#       part_marge_buts_moins_1_A,
#       part_marge_buts_moins_2_A,
#       part_marge_buts_moins_3_A,
#       part_marge_buts_moins_4_A,
#       part_marge_buts_ecart_1_A,
#       part_marge_buts_ecart_2_A,
#       part_marge_buts_ecart_3_A,
#       part_marge_buts_ecart_4_A,
#       part_clean_sheet_A,
#          part_nb_0p5_buts_A,
#            part_nb_1p5_buts_A,
#            part_nb_2p5_buts_A,
#            part_nb_3p5_buts_A,
#            part_nb_4p5_buts_A,
#            part_nb_0p5_buts_marq_A,
#            part_nb_1p5_buts_marq_A,
#            part_nb_2p5_buts_marq_A,
#            part_nb_3p5_buts_marq_A,
#            part_nb_4p5_buts_marq_A,
#            part_nb_0p5_buts_enc_A,
#            part_nb_1p5_buts_enc_A,
#            part_nb_2p5_buts_enc_A,
#            part_nb_3p5_buts_enc_A,
#            part_nb_4p5_buts_enc_A
#   )
#     
```

```{r}
classement_actu=classement
classement_anc=classement %>%
  mutate(nb_matchs=nb_matchs-8,nb_matchs_H=nb_matchs_H-4,nb_matchs_A=nb_matchs_A-4) %>%
  filter(nb_matchs>0)

classement_temp_tot=merge(classement_actu,classement_anc,by=c('Team','nb_matchs','saison')) %>%
  mutate(
    nb_matchs=nb_matchs+8,
    points_8d=points.y-points.x,
    nb_vict_8d=nb_vict.y-nb_vict.x,
    nb_def_8d=nb_def.y-nb_def.x,
    nb_nul_8d=nb_nul.y-nb_nul.x,
    nb_nonunique_8d=nb_nonunique.y-nb_nonunique.x,
    nb_unique_8d=nb_unique.y-nb_unique.x,
    buts_marq_8d=buts_marq.y-buts_marq.x,
    buts_enc_8d=buts_enc.y-buts_enc.x,
    nb_0p5_buts_8d=nb_0p5_buts.y-nb_0p5_buts.x,
nb_1p5_buts_8d=nb_1p5_buts.y-nb_1p5_buts.x,
nb_2p5_buts_8d=nb_2p5_buts.y-nb_2p5_buts.x,
nb_3p5_buts_8d=nb_3p5_buts.y-nb_3p5_buts.x,
nb_4p5_buts_8d=nb_4p5_buts.y-nb_4p5_buts.x,
nb_0p5_buts_marq_8d=nb_0p5_buts_marq.y-nb_0p5_buts_marq.x,
nb_1p5_buts_marq_8d=nb_1p5_buts_marq.y-nb_1p5_buts_marq.x,
nb_2p5_buts_marq_8d=nb_2p5_buts_marq.y-nb_2p5_buts_marq.x,
nb_3p5_buts_marq_8d=nb_3p5_buts_marq.y-nb_3p5_buts_marq.x,
nb_4p5_buts_marq_8d=nb_4p5_buts_marq.y-nb_4p5_buts_marq.x,
nb_0p5_buts_enc_8d=nb_0p5_buts_enc.y-nb_0p5_buts_enc.x,
nb_1p5_buts_enc_8d=nb_1p5_buts_enc.y-nb_1p5_buts_enc.x,
nb_2p5_buts_enc_8d=nb_2p5_buts_enc.y-nb_2p5_buts_enc.x,
nb_3p5_buts_enc_8d=nb_3p5_buts_enc.y-nb_3p5_buts_enc.x,
nb_4p5_buts_enc_8d=nb_4p5_buts_enc.y-nb_4p5_buts_enc.x
  ) %>%
  dplyr::select(Team,saison,nb_matchs,ends_with("8d")) %>%
  unique()

classement_temp_H=merge(classement_actu,classement_anc,by=c('Team','nb_matchs_H','saison')) %>%
  mutate(
    nb_matchs=nb_matchs.x+8,
    points_H_8d=points_H.y-points_H.x,
    nb_vict_H_8d=nb_vict_H.y-nb_vict_H.x,
    nb_def_H_8d=nb_def_H.y-nb_def_H.x,
    nb_nul_H_8d=nb_nul_H.y-nb_nul_H.x,
    nb_nonunique_H_8d=nb_nonunique_H.y-nb_nonunique_H.x,
    nb_unique_H_8d=nb_unique_H.y-nb_unique_H.x,
  buts_marq_H_8d=buts_marq_H.y-buts_marq_H.x,
    buts_enc_H_8d=buts_enc_H.y-buts_enc_H.x,
nb_0p5_buts_H_8d=nb_0p5_buts_H.y-nb_0p5_buts_H.x,
nb_1p5_buts_H_8d=nb_1p5_buts_H.y-nb_1p5_buts_H.x,
nb_2p5_buts_H_8d=nb_2p5_buts_H.y-nb_2p5_buts_H.x,
nb_3p5_buts_H_8d=nb_3p5_buts_H.y-nb_3p5_buts_H.x,
nb_4p5_buts_H_8d=nb_4p5_buts_H.y-nb_4p5_buts_H.x,
nb_0p5_buts_marq_H_8d=nb_0p5_buts_marq_H.y-nb_0p5_buts_marq_H.x,
nb_1p5_buts_marq_H_8d=nb_1p5_buts_marq_H.y-nb_1p5_buts_marq_H.x,
nb_2p5_buts_marq_H_8d=nb_2p5_buts_marq_H.y-nb_2p5_buts_marq_H.x,
nb_3p5_buts_marq_H_8d=nb_3p5_buts_marq_H.y-nb_3p5_buts_marq_H.x,
nb_4p5_buts_marq_H_8d=nb_4p5_buts_marq_H.y-nb_4p5_buts_marq_H.x,
nb_0p5_buts_enc_H_8d=nb_0p5_buts_enc_H.y-nb_0p5_buts_enc_H.x,
nb_1p5_buts_enc_H_8d=nb_1p5_buts_enc_H.y-nb_1p5_buts_enc_H.x,
nb_2p5_buts_enc_H_8d=nb_2p5_buts_enc_H.y-nb_2p5_buts_enc_H.x,
nb_3p5_buts_enc_H_8d=nb_3p5_buts_enc_H.y-nb_3p5_buts_enc_H.x,
nb_4p5_buts_enc_H_8d=nb_4p5_buts_enc_H.y-nb_4p5_buts_enc_H.x
  ) %>%
  dplyr::select(Team,saison,nb_matchs,ends_with("8d")) %>%
  unique()

classement_temp_A=merge(classement_actu,classement_anc,by=c('Team','nb_matchs_A','saison')) %>%
  mutate(
    nb_matchs=nb_matchs.x+8,
    points_A_8d=points_A.y-points_A.x,
    nb_vict_A_8d=nb_vict_A.y-nb_vict_A.x,
    nb_def_A_8d=nb_def_A.y-nb_def_A.x,
    nb_nul_A_8d=nb_nul_A.y-nb_nul_A.x,
    nb_nonunique_A_8d=nb_nonunique_A.y-nb_nonunique_A.x,
    nb_unique_A_8d=nb_unique_A.y-nb_unique_A.x,
    buts_marq_A_8d=buts_marq_A.y-buts_marq_A.x,
    buts_enc_A_8d=buts_enc_A.y-buts_enc_A.x,
nb_0p5_buts_A_8d=nb_0p5_buts_A.y-nb_0p5_buts_A.x,
nb_1p5_buts_A_8d=nb_1p5_buts_A.y-nb_1p5_buts_A.x,
nb_2p5_buts_A_8d=nb_2p5_buts_A.y-nb_2p5_buts_A.x,
nb_3p5_buts_A_8d=nb_3p5_buts_A.y-nb_3p5_buts_A.x,
nb_4p5_buts_A_8d=nb_4p5_buts_A.y-nb_4p5_buts_A.x,
nb_0p5_buts_marq_A_8d=nb_0p5_buts_marq_A.y-nb_0p5_buts_marq_A.x,
nb_1p5_buts_marq_A_8d=nb_1p5_buts_marq_A.y-nb_1p5_buts_marq_A.x,
nb_2p5_buts_marq_A_8d=nb_2p5_buts_marq_A.y-nb_2p5_buts_marq_A.x,
nb_3p5_buts_marq_A_8d=nb_3p5_buts_marq_A.y-nb_3p5_buts_marq_A.x,
nb_4p5_buts_marq_A_8d=nb_4p5_buts_marq_A.y-nb_4p5_buts_marq_A.x,
nb_0p5_buts_enc_A_8d=nb_0p5_buts_enc_A.y-nb_0p5_buts_enc_A.x,
nb_1p5_buts_enc_A_8d=nb_1p5_buts_enc_A.y-nb_1p5_buts_enc_A.x,
nb_2p5_buts_enc_A_8d=nb_2p5_buts_enc_A.y-nb_2p5_buts_enc_A.x,
nb_3p5_buts_enc_A_8d=nb_3p5_buts_enc_A.y-nb_3p5_buts_enc_A.x,
nb_4p5_buts_enc_A_8d=nb_4p5_buts_enc_A.y-nb_4p5_buts_enc_A.x
  ) %>%
  dplyr::select(Team,saison,nb_matchs,ends_with("8d")) %>%
  unique()    

    
 classement_temp_A1 =classement_temp_A %>%
   arrange(desc(saison),desc(nb_matchs),Team) %>%
   filter(saison==102) %>%
   group_by(Team) %>%
   slice(1) %>%
   mutate(nb_matchs=nb_matchs+1) %>%
    as.data.frame()
classement_temp_A=rbind(classement_temp_A1,classement_temp_A) 
  classement_temp_H1 =classement_temp_H %>%
   arrange(desc(saison),desc(nb_matchs),Team) %>%
   filter(saison==102) %>%
   group_by(Team) %>%
   slice(1) %>%
   mutate(nb_matchs=nb_matchs+1) %>%
    as.data.frame()
classement_temp_H= rbind(classement_temp_H,classement_temp_H1)
    
  
#str(classement_temp)
```

#Modélisation analyse discriminantes PLS-DA (variable quali) / 8 derniers matchs
```{r}
#install.packages("devtools")
# then load
library(devtools)
#install_github("mixOmicsTeam/mixOmics")
  #PLS regression
library(mixOmics)

nogoal=score_france_ %>%
  dplyr::select(saison,Date,Team_home,Team_away,Final_H,Final_A,classement_A,classement_H,nb_matchs) %>%
  mutate(unique_teamgoal=ifelse(as.numeric(as.character(Final_A))==0 | as.numeric(as.character(Final_H))==0,'1','0'),
  pos_class_team_A=ifelse(classement_A<=5,1,
                      ifelse(classement_A<=10 & classement_A>=6,2,
                             ifelse(classement_A<=15 & classement_A>=11,3,ifelse(classement_A<=20 & classement_A>=16,4,0)))) , 
pos_class_team_H=ifelse(classement_H<=5,1,
                      ifelse(classement_H<=10 & classement_H>=6,2,
                             ifelse(classement_H<=15 & classement_H>=11,3,ifelse(classement_H<=20 & classement_H>=16,4,0))))) %>%
  left_join(classement_temp_H ,by=c("saison"="saison","Team_home"="Team","nb_matchs"="nb_matchs")) %>%
  left_join(classement_temp_tot ,by=c("saison"="saison","Team_home"="Team","nb_matchs"="nb_matchs")) %>%
   left_join(classement_temp_A,by=c("saison"="saison","Team_away"="Team","nb_matchs"="nb_matchs")) %>%
  left_join(classement_temp_tot ,by=c("saison"="saison","Team_away"="Team","nb_matchs"="nb_matchs")) %>%
  arrange(desc(Date)) %>%
  filter(is.na(points_H_8d)==F)

  table(nogoal$unique_teamgoal,nogoal$nb_unique_A_8d)
    table(nogoal$unique_teamgoal,nogoal$nb_unique_H_8d)
      table(nogoal$unique_teamgoal,nogoal$nb_unique_8d.x)
    table(nogoal$unique_teamgoal,nogoal$nb_unique_8d.y)
 
#set.seed(101) # Set Seed so that same sample can be reproduced in future also
# Now Selecting 75% of data as sample from total 'n' rows of the data 
validation=nogoal %>% filter(saison<100)
 nogoal_app=nogoal %>% filter(saison>=100) #%>%
#   filter(is.na(unique_teamgoal)==F)
nogoal_sans_valt=nogoal_app[c(1:69),]
 nogoal_app=nogoal %>% filter(saison>=100) %>%
   filter(is.na(unique_teamgoal)==F)
 
 nogoal_sans_val=nogoal_app[-c(1:35),]
sample <- sample.int(n = nrow(nogoal_sans_val), size = floor(.80*nrow(nogoal_sans_val)), replace = F)
train <- nogoal_sans_val[sample, ]
test  <- nogoal_sans_val[-sample, ]
test=rbind(test,nogoal_sans_valt)#,validation)
nogoal_train= train %>%
dplyr::select(-c(saison,Date,Final_H,Team_home,Team_away,classement_H,classement_A,Final_A,nb_matchs))

nogoal_test= test %>%
dplyr::select(-c(saison,Date,Final_H,Team_home,Team_away,classement_H,classement_A,Final_A,nb_matchs))

nogoal_validation= validation %>%
dplyr::select(-c(saison,Date,Final_H,Team_home,Team_away,classement_H,classement_A,Final_A,nb_matchs))

X <- as.matrix(nogoal_train[,-1])
Y <- as.factor(nogoal_train[,1])
Xtest <- as.matrix(nogoal_test[,-1])
Ytest <- as.factor(nogoal_test[,1])

Xvalidation <- as.matrix(nogoal_validation[,-1])
Yvalidation <- as.factor(nogoal_validation[,1])
list.keepX <- c(seq(10, 100, 5))
tune.splsda <- tune.splsda(X, Y, ncomp = 3, validation = 'Mfold', folds = 5, 
                           progressBar = TRUE, dist = 'max.dist',
                           test.keepX = list.keepX, nrepeat = 100) 

tune.splsda$error.rate.class
tune.splsda$choice.keepX
tune.splsda$choice.ncomp$ncomp

choice.ncomp <- tune.splsda$choice.ncomp$ncomp
choice.keepX <- tune.splsda$choice.keepX[1:choice.ncomp]
## sPLS-DA function
 
splsda.res <- splsda(X, Y, ncomp =choice.ncomp , keepX = choice.keepX)
 
# for (i in 1:67) {
# splsda.train <- splsda(X, Y, ncomp = 3,keepX = c(20,75,10))
# test.predict <- predict(splsda.train,Xtest, dist = "max.dist")
# # store prediction for the 4th component
# prediction <- test.predict$class$max.dist[,1] 
# 
# 
# # calculate the error rate of the model
# confusion.mat = get.confusion_matrix(truth = Ytest, predicted = prediction)
# print(i)
# print(get.BER(confusion.mat)) 
# }


# perf.splsda <- perf(splsda.res, validation = "Mfold", folds = 5, 
#                   progressBar = FALSE, auc = TRUE, nrepeat = 10) 
# 
#splsda.res$error.rate
 
# 
# selectVar(splsda.res, comp = 1)$value
 
test.predict <- predict(splsda.res, Xtest, dist = "max.dist")
# store prediction for the 4th component
prediction <- test.predict$class$max.dist[,choice.ncomp] 
# calculate the error rate of the model
confusion.mat = get.confusion_matrix(truth = Ytest, predicted = prediction)
get.BER(confusion.mat)

prediction_finale =as.data.frame(cbind(test.predict$predict[,,tune.splsda$choice.ncomp$ncomp],prediction,test$unique_teamgoal,test)) %>%
  mutate(uniquegoal=as.character(`test$unique_teamgoal`)) 

validation.predict <- predict(splsda.res, Xvalidation, dist = "max.dist")
# store prediction for the 4th component
prediction <- validation.predict$class$max.dist[,choice.ncomp] 
# calculate the error rate of the model
confusion.mat = get.confusion_matrix(truth = Yvalidation, predicted = prediction)
get.BER(confusion.mat)
 

 prediction_finale_val =as.data.frame(cbind(validation.predict$predict[,,tune.splsda$choice.ncomp$ncomp],prediction,validation$unique_teamgoal,validation)) %>%
  mutate(uniquegoal=as.character(`validation$unique_teamgoal`)) 

 
 

 prediction_finale_sans_na_1=prediction_finale %>%
   filter(uniquegoal %in% c('0','1') & `1`>0.5) %>%
   dplyr::select(`1`,prediction,uniquegoal,saison,Date,Team_home,Team_away) %>%
    arrange(desc(`1`)) %>%
   mutate(bon=ifelse(uniquegoal==prediction,1,0),
          tot=1,
          deciles=ifelse(`1`>0.95,1,
                   ifelse(`1`>0.90,2,
                   ifelse(`1`>0.85,3,
                   ifelse(`1`>0.80,4,
                   ifelse(`1`>0.75,5,
                   ifelse(`1`>0.70,6,
                   ifelse(`1`>0.65,7,
                   ifelse(`1`>0.60,8,9
                         ))))))))) %>%
   group_by(deciles) %>%
   summarise(bon_sum=sum(bon),tot=sum(tot)) %>%
 mutate(pct=bon_sum/tot,erreur=tot-bon_sum)
 
 prediction_finale_sans_na_team_1=prediction_finale %>%
   filter(uniquegoal %in% c('0','1') & `1`>0.5) %>%
   dplyr::select(`1`,prediction,uniquegoal,saison,Date,Team_home) %>%
   rename(Team=Team_home)
 
  prediction_finale_sans_na_team_2=prediction_finale %>%
   filter(uniquegoal %in% c('0','1') & `1`>0.5) %>%
   dplyr::select(`1`,prediction,uniquegoal,saison,Date,Team_away) %>%
   rename(Team=Team_away)
 
 
prediction_finale_sans_na_team=rbind(prediction_finale_sans_na_team_1,prediction_finale_sans_na_team_2)

prediction_finale_sans_na_1=prediction_finale_sans_na_team %>%
   
   mutate(bon=ifelse(uniquegoal==prediction,1,0),
          tot=1,
          deciles=ifelse(`1`>0.95,1,
                   ifelse(`1`>0.90,2,
                   ifelse(`1`>0.85,3,
                   ifelse(`1`>0.80,4,
                   ifelse(`1`>0.75,5,
                   ifelse(`1`>0.70,6,
                   ifelse(`1`>0.65,7,
                   ifelse(`1`>0.60,8,9
                         ))))))))) %>%
   group_by(deciles,Team) %>%
   summarise(bon_sum=sum(bon),tot=sum(tot)) %>%
 mutate(pct=bon_sum/tot,erreur=tot-bon_sum)
 
 plot(prediction_finale_sans_na_1$part_bon,prediction_finale_sans_na_1$`1`)
 
 
 prediction_finale_sans_na_0=prediction_finale %>%
   filter(uniquegoal %in% c('0','1') & `0`>0.5) %>%
    arrange(desc(`0`)) %>%
   mutate(bon=ifelse(uniquegoal==prediction,1,0),
          tot=1,
          deciles=ifelse(`0`>0.95,1,
                   ifelse(`0`>0.90,2,
                   ifelse(`0`>0.85,3,
                   ifelse(`0`>0.80,4,
                   ifelse(`0`>0.75,5,
                   ifelse(`0`>0.70,6,
                   ifelse(`0`>0.65,7,
                   ifelse(`0`>0.60,8,9
                         ))))))))) %>%
   group_by(deciles) %>%
   summarise(bon_sum=sum(bon),tot=sum(tot)) %>%
 mutate(pct=bon_sum/tot,erreur=tot-bon_sum)
 
 
 plot(prediction_finale_sans_na_0$part_bon,prediction_finale_sans_na_0$`0`)
 
 
 #Comparaison probabilité pred 3 model
 
 
 
```

#Modélisation du nombre de buts : +2,5 ou moins
```{r}

nogoal=score_france_ %>%
  dplyr::select(saison,Date,Team_home,Team_away,Final_H,Final_A,classement_A,classement_H,nb_matchs) %>%
  mutate(plus2buts=ifelse(as.numeric(as.character(Final_A))+as.numeric(as.character(Final_H))>=3,'1','0'),
  pos_class_team_A=ifelse(classement_A<=5,1,
                      ifelse(classement_A<=10 & classement_A>=6,2,
                             ifelse(classement_A<=15 & classement_A>=11,3,ifelse(classement_A<=20 & classement_A>=16,4,0)))) , 
pos_class_team_H=ifelse(classement_H<=5,1,
                      ifelse(classement_H<=10 & classement_H>=6,2,
                             ifelse(classement_H<=15 & classement_H>=11,3,ifelse(classement_H<=20 & classement_H>=16,4,0))))) %>%
  left_join(classement_temp_H ,by=c("saison"="saison","Team_home"="Team","nb_matchs"="nb_matchs")) %>%
  left_join(classement_temp_tot ,by=c("saison"="saison","Team_home"="Team","nb_matchs"="nb_matchs")) %>%
   left_join(classement_temp_A,by=c("saison"="saison","Team_away"="Team","nb_matchs"="nb_matchs")) %>%
  left_join(classement_temp_tot ,by=c("saison"="saison","Team_away"="Team","nb_matchs"="nb_matchs")) %>%
  arrange(desc(Date)) %>%
  filter(is.na(points_H_8d)==F)

 
 
#set.seed(101) # Set Seed so that same sample can be reproduced in future also
# Now Selecting 75% of data as sample from total 'n' rows of the data 
validation=nogoal %>% filter(saison<100)
 nogoal_app=nogoal %>% filter(saison>=100) #%>%
#   filter(is.na(unique_teamgoal)==F)
nogoal_sans_valt=nogoal_app[c(1:69),]
 nogoal_app=nogoal %>% filter(saison>=100) %>%
   filter(is.na(plus2buts)==F)
 
 nogoal_sans_val=nogoal_app[-c(1:35),]
sample <- sample.int(n = nrow(nogoal_sans_val), size = floor(.80*nrow(nogoal_sans_val)), replace = F)
train <- nogoal_sans_val[sample, ]
test  <- nogoal_sans_val[-sample, ]
test=rbind(test,nogoal_sans_valt)#,validation)
nogoal_train= train %>%
dplyr::select(-c(saison,Date,Final_H,Team_home,Team_away,classement_H,classement_A,Final_A,nb_matchs))

nogoal_test= test %>%
dplyr::select(-c(saison,Date,Final_H,Team_home,Team_away,classement_H,classement_A,Final_A,nb_matchs))

nogoal_validation= validation %>%
dplyr::select(-c(saison,Date,Final_H,Team_home,Team_away,classement_H,classement_A,Final_A,nb_matchs))

X <- as.matrix(nogoal_train[,-1])
Y <- as.factor(nogoal_train[,1])
Xtest <- as.matrix(nogoal_test[,-1])
Ytest <- as.factor(nogoal_test[,1])

Xvalidation <- as.matrix(nogoal_validation[,-1])
Yvalidation <- as.factor(nogoal_validation[,1])
list.keepX <- c(seq(10, 100, 5))
tune.splsda <- tune.splsda(X, Y, ncomp = 3, validation = 'Mfold', folds = 5, 
                           progressBar = TRUE, dist = 'max.dist',
                           test.keepX = list.keepX, nrepeat = 100) 

tune.splsda$error.rate.class
tune.splsda$choice.keepX
tune.splsda$choice.ncomp$ncomp

choice.ncomp <- tune.splsda$choice.ncomp$ncomp
choice.keepX <- tune.splsda$choice.keepX[1:choice.ncomp]
## sPLS-DA function
 
splsda.res <- splsda(X, Y, ncomp =choice.ncomp , keepX = choice.keepX)
 
# for (i in 1:67) {
# splsda.train <- splsda(X, Y, ncomp = 3,keepX = c(20,75,10))
# test.predict <- predict(splsda.train,Xtest, dist = "max.dist")
# # store prediction for the 4th component
# prediction <- test.predict$class$max.dist[,1] 
# 
# 
# # calculate the error rate of the model
# confusion.mat = get.confusion_matrix(truth = Ytest, predicted = prediction)
# print(i)
# print(get.BER(confusion.mat)) 
# }


# perf.splsda <- perf(splsda.res, validation = "Mfold", folds = 5, 
#                   progressBar = FALSE, auc = TRUE, nrepeat = 10) 
# 
#splsda.res$error.rate
 
# 
# selectVar(splsda.res, comp = 1)$value
 
test.predict <- predict(splsda.res, Xtest, dist = "max.dist")
# store prediction for the 4th component
prediction <- test.predict$class$max.dist[,choice.ncomp] 
# calculate the error rate of the model
confusion.mat = get.confusion_matrix(truth = Ytest, predicted = prediction)
get.BER(confusion.mat)

prediction_finale =as.data.frame(cbind(test.predict$predict[,,tune.splsda$choice.ncomp$ncomp],prediction,test$plus2buts,test)) %>%
  mutate(uniquegoal=as.character(`test$plus2buts`)) 

```



#Random forest
```{r}
library(randomForest)
XX=nogoal_train[,-1]
model <- randomForest(as.factor(unique_teamgoal) ~ ., data = nogoal_train, ntree = 10000, na.action = na.omit)

hist(model$oob.times)

model$importance
varImpPlot(model)
test$predicted <- predict(model, test)
table(test$predicted, test$unique_teamgoal) 

testo = test %>% 
  dplyr::select(unique_teamgoal,Team_home,Team_away,Date,predicted)


library(Factomin)

library(FactoMineR)
pr_acp=rbind(nogoal_train,nogoal_test)
pr_acp=pr_acp[,-1]

#for (i in 3:30){
  
 
res.pca <- PCA(pr_acp, graph = FALSE,ncp = 17)
# eig.val <- res.pca$eig
# barplot(eig.val[, 2], 
#         names.arg = 1:nrow(eig.val), 
#         main = "Variances Explained by PCs (%)",
#         xlab = "Principal Components",
#         ylab = "Percentage of variances",
#         col ="steelblue")
# # Add connected line segments to the plot
# lines(x = 1:nrow(eig.val), eig.val[, 2], 
#       type = "b", pch = 19, col = "red")
# 
# plot(res.pca, choix = "ind", autoLab = "yes")
# plot(res.pca, choix = "var", autoLab = "yes")

# Valeurs propres
 
acp_train=cbind(nogoal_train,res.pca$ind$coord[1:nrow(nogoal_train),]) %>% dplyr::select(unique_teamgoal,starts_with('Dim'))
acp_test=cbind(nogoal_test,res.pca$ind$coord[-c(1:nrow(nogoal_train)),]) %>% dplyr::select(unique_teamgoal,starts_with('Dim')) 


model <- randomForest(as.factor(unique_teamgoal) ~ ., data = acp_train, ntree = 10000, na.action = na.omit)

# hist(model$oob.times)
# 
# model$importance
# varImpPlot(model)
test$predicted <- predict(model, acp_test)
print(table(test$predicted, test$unique_teamgoal))
#}
testo = test %>% 
  dplyr::select(unique_teamgoal,Team_home,Team_away,Date,predicted) %>%
  mutate(erreur=ifelse(predicted==unique_teamgoal,1,0)) %>%
  arrange(desc(Date)) %>%
  mutate(erreur_cum=cumsum(erreur),tot=row_number())
plot(testo$erreur_cum,testo$tot)

train$predicted <- predict(model, acp_train)
print(table(train$predicted, train$unique_teamgoal))

logitMod <- glm(as.factor(unique_teamgoal) ~ ., data = acp_train, family=binomial(link="logit"))
test$predicted_log <- predict(logitMod, acp_test, type="response")
test=test %>%
  mutate(predicted_logi=ifelse(predicted_log>0.5,1,0))
print(table(test$predicted_logi, test$unique_teamgoal))
print(table(test$predicted_logi, test$predicted))

testo = test %>% 
  dplyr::select(unique_teamgoal,Team_home,Team_away,Date,predicted,predicted_logi,predicted_log) %>%
  mutate(erreur=ifelse(predicted==unique_teamgoal,1,0)) %>%
  arrange(desc(Date)) %>%
  mutate(erreur_cum=cumsum(erreur),tot=row_number())

ens=cbind(prediction_finale,testo)
table(ens$prediction,ens$predicted_logi)

#LOOCV

acc <- NULL
for(i in 1:nrow(nogoal_train))
{
 
    # Train-test splitting
    # 499 samples -> fitting
    # 1 sample -> testing
    #traini <- acp_train[-i,]
    #testi <- acp_train[i,]
    
X <- as.matrix(nogoal_train[-i,-1])
Y <- as.factor(nogoal_train[-i,1])
 
Xtest <- as.matrix(nogoal_train[i,-1])
Ytest <- as.factor(nogoal_train[i,1])   
    # Fitting
    #model <-glm(as.factor(unique_teamgoal) ~ ., data = traini, family=binomial(link="logit"))
    model <- splsda(X, Y, ncomp =choice.ncomp , keepX = choice.keepX)
    # Predict results
    #results_prob <- predict(model,subset(testi,type='response'))
    results_prob <- predict(splsda.res, Xtest, dist = "max.dist")
    # If prob > 0.5 then 1, else 0
    results <- ifelse(as.numeric(results_prob$predict[,,tune.splsda$choice.ncomp$ncomp][2])  > 0.5,1,0)
     
    # Actual answers
    answers <- as.numeric(testi$unique_teamgoal)
    
    # Calculate accuracy
    misClasificError <- mean(answers != results)
    
    # Collecting results
    acc[i] <- 1-misClasificError
}

# Average accuracy of the model
mean(acc)

# Histogram of the model accuracy
hist(acc,xlab='Accuracy',ylab='Freq',main='Accuracy LOOCV',
     col='cyan',border='blue',density=30)
```

